"use strict";(function(){var o=Array.prototype.slice.call(window.document.getElementsByTagName("script")).pop();(function(){Array.prototype.findIndex||(Array.prototype.findIndex=function(n){for(var i=this,t=0,r=this.length;t<r;t++)if(n.call(i,this[t],t))return t;return-1});Array.from||(Array.from=function(n){for(var i=[],t=0,r=n.length;t<r;t++)i.push(n[t]);return i})})();var s=function(n,t){Array.from(typeof n.length!="undefined"?n:[n]).forEach(function(n){n.addEventListener("click",t)})},n=function(n,t,i){s(n.querySelectorAll("."+t),i)},h=function(n,t,i){s(n.getElementsByTagName(t),i)},w=function(n){var t={};return Object.keys(n).forEach(function(i){t[i]=n[i]}),t},t=function(n){n.classList.add("hidden")},u=function(n){return!n.classList.contains("hidden")},i=function(n){for(var t=undefined,i,r=0,u=n.length;r<u;r++)i=n[r],t=t===undefined?i:Math.max(t,i);return t},f=function(n){for(var t=undefined,i,r=0,u=n.length;r<u;r++)i=n[r],t=t===undefined?i:Math.min(t,i);return t},c=function(n){return Object.keys(e()).findIndex(function(t){return t.toLowerCase()===n.toLowerCase()})>=0},e=function(n){var t=(n=n||window.location.href).indexOf("?"),i={};return t>=0&&(n=n.substr(t+1),t=n.indexOf("#"),t>=0&&(n=n.substr(0,t)),n.split("&").forEach(function(n){var t=n.indexOf("="),r=n.substr(0,t),u=n.substr(t+1);i[r||u]=r?window.decodeURIComponent(u):undefined})),i},l=function(n,t){var i;t&&(i=document.getElementById(t))?i.innerText=n:(i=document.createElement("style"),i.setAttribute("type","text/css"),t&&i.setAttribute("id",t),i.innerText=n,document.querySelector("head").appendChild(i))},r=function(n){n.classList.remove("hidden")},v=function(n,t){n.completed?t():n.executing?n.callbacks.push(t):(n.callbacks=[t],n.executing=!0,n(function(){n.completed=!0;n.executing=!1;for(var t=0,i=n.callbacks.length;t<i;t++)n.callbacks[t]()}))},y=c("debug"),p="map-style",a;(function(){var n={get depth(){return 6},get padding(){return 8}},h,c=function(t,i){var o=document.createElement("canvas"),u,f=t+n.depth,e=i+n.depth,r;return o.setAttribute("width",f),o.setAttribute("height",e),r=o.getContext("2d"),r.fillStyle="",u=r.createLinearGradient(0,i,0,e),u.addColorStop(0,"rgba(0, 0, 0, 0.25)"),u.addColorStop(1,"rgba(0, 0, 0, 0.75)"),r.fillStyle=u,r.beginPath(),r.moveTo(0,i),r.lineTo(n.depth,e),r.lineTo(f,e),r.lineTo(t,i),r.closePath(),r.fill(),u=r.createLinearGradient(t,0,f,0),u.addColorStop(0,"rgba(0, 0, 0, 0.25)"),u.addColorStop(1,"rgba(0, 0, 0, 0.75)"),r.fillStyle=u,r.beginPath(),r.moveTo(t,0),r.lineTo(t,i),r.lineTo(f,e),r.lineTo(f,n.depth),r.closePath(),r.fill(),o.toDataURL()},b=function(n){v(k,n)},k=function(t){var i=new Image,r;i.onload=function(){var y=this.width/9,p=this.height/5;Object.defineProperty(n,"width",{get:function(){return y}});Object.defineProperty(n,"height",{get:function(){return p}});var f,w="polygon("+n.width+"px 0, 100% "+n.depth+"px, 100% 100%, "+n.depth+"px 100%, 0 "+n.height+"px, 0 0)",s,i,r,e,u,a,o=0,v=0;for(f=['.face { background-image: url("'+this.src+'") !important; width: '+n.width+"px; height: "+n.height+"px; }",".tile { width: "+(n.width+n.depth)+"px; height: "+(n.height+n.depth)+"px; background-image: url("+c(n.width,n.height)+"); background-repeat: no-repeat; "+["","ms","moz","o","webkit"].map(function(n){return(n?"-"+n+"-":"")+"clip-path: "+w}).join("; ")+"}"],h=[],i=0;i<5;i++)for(s=i===3?8:i===4?7:9,r=0;r<s;r++){for(f.push(".t"+o+"{ background-position: -"+n.width*r+"px -"+n.height*i+"px }"),u=i>2&&r<4?1:4,(u!==1||a!==u)&&v++,e=0;e<u;e++)h.push({background:{x:-(n.width*r),y:-(n.height*i)},face:o,index:h.length,type:v});o++;a=u}l(f.join("\n"));t()};r=o.getAttribute("palette")||e(o.getAttribute("src")).palette||e(window.location.href).palette;i.src=r},d=function(n,t){var i=[],r,f,u,e;for(t.forEach(function(t){i.push({x:t.x,y:n.y,w:t.w,h:n.h});i.push({x:n.x,y:t.y,w:n.w,h:t.h})}),r=0;f=i[r];r++)for(u=0;e=t[u];u++)if(!g(f,e))return!1;return!0},w=function(t){var v=f(t.map(function(n){return n.x})),k=i(t.map(function(n){return n.x+n.w})),y=f(t.map(function(n){return n.y})),d=i(t.map(function(n){return n.y+n.h})),b=f(t.map(function(n){return n.z})),g=i(t.map(function(n){return n.z})),nt=i(t.map(function(n){return n.w})),tt=i(t.map(function(n){return n.h})),r=k-v,u=d-y,o=t.length%4,a,e;return o?(function(){var i=t.slice(),n;i.sort(function(n,t){return t.z-n.z});o=i.slice(0,o);n=t.filter(function(n){return o.findIndex(function(t){return t===n})<0});n.splice(0,0,0,t.length);t.splice.apply(t,n)}(),w(t)):((v!==0||y!==0)&&t.forEach(function(n){n.x-=v;n.y-=y}),b!==0&&t.forEach(function(n){n.z-=b}),r*=n.width,r+=n.depth,r+=2*n.padding,t.width=r,u*=n.height,u+=n.depth,u+=2*n.padding,t.height=u,a=[".wrapper { max-width: "+r+"px; max-height:"+u+"px; }",".board { width: "+r+"px; height: "+u+"px; }"],function(){for(var t,u,r,i=1;i<=nt;i++)for(t=1;t<=tt;t++)(i!==1||t!==1)&&(r=[],r.push('background-image: url("'+c(n.width*i,n.height*t)+'")'),r.push("width: "+(i*n.width+n.depth)+"px"),r.push("height: "+(t*n.height+n.depth)+"px"),r.push("clip-path: polygon("+i*n.width+"px 0, 100% "+n.depth+"px, 100% 100%, "+n.depth+"px 100%, 0 "+t*n.height+"px, 0 0)"),a.push(".tile.w-"+i+".h-"+t+" { "+r.join("; ")+" }"),u=[],u.push("background-size: "+n.width*9*i+"px "+n.height*5*t+"px"),u.push("width: "+i*n.width+"px"),u.push("height: "+t*n.height+"px"),a.push(".tile.w-"+i+".h-"+t+" .face { "+u.join("; ")+" }"))}(),l(a.join("\n"),p),function(){var a=0,o,u=t.findIndex(function(n){return typeof n.faceIndex!="undefined"})<0,f=u?"type":"faceIndex",i,n,v,r,c,l;do{if(n=h.slice(),c={},a++,u){while(t.length<n.length)i=Math.floor(Math.random()*n.length),i=n[i].type,v=c[i]?0:2,c[i]=!0,r=0,n=n.filter(function(n){return n.type!==i||r++<v});while(t.length>n.length)i=Math.floor(Math.random()*n.length),i=n[i].type,r=n.length,o=n.filter(function(n){return n.type===i}).slice(0,2).map(function(n){return{background:{x:n.background.x,y:n.background.y},face:n.face,index:r++,type:n.type}}),o.splice(0,0,0,0),n.splice.apply(n,o);l=n}else l=t;e={};l.forEach(function(n){typeof e[n[f]]!="undefined"?e[n[f]]++:e[n[f]]=1});t.forEach(function(t,i){t.index=i;var f=u?Math.floor(Math.random()*n.length):t.faceIndex,r=n[f];t.background=r.background;t.face=r.face;t.type=r.type;u&&n.splice(f,1)})}while(function(){var n,o,h,c,r,u,i;for(r=t.filter(function(n){return n.z}),n=0,h=r.length;n<h;n++)for(u=r[n],c=e[u[f]]/2,o=0,i=b;i<=g;i++)if(i!==u.z&&t.findIndex(function(t){return t.z===i&&t.type===u.type&&s(r[n],t)})>=0&&++o>=c){if(a>Math.pow(t.length,2))throw new Error;return!0}}())}(),e)},g=function(n,t){return t.x<=n.x&&t.x+t.w>=n.x+n.w&&t.y<=n.y&&t.y+t.h>=n.y+n.h},s=function(n,t){return n!==t&&n.y+n.h>t.y&&n.y<t.y+t.h&&n.x+n.w>t.x&&n.x<t.x+t.w};a=function(i,f,e){var g=0,o,nt=0,c,a=[],h=[],tt,l,it,p=function(n,t){var r=n.dataset.type;return Array.from(i.getElementsByClassName("tile")).filter(function(i){return i!==n&&i.dataset.type===r&&(!t||i.classList.contains("free"))})},v=function(n){return{index:parseInt(n.dataset.index),x:parseFloat(n.dataset.x),y:parseFloat(n.dataset.y),z:parseFloat(n.dataset.z),w:parseFloat(n.dataset.w),h:parseFloat(n.dataset.h)}},k=function(){var n;g=0;nt=0,function(){var n=Array.from(i.getElementsByClassName("tile")).map(function(n){var t=v(n);return t.index=parseInt(n.dataset.index),t.visible=u(n),t}),r=n.filter(function(t){var i=n.filter(function(n){return n.index!==t.index&&n.visible&&n.z===t.z&&n.y+n.h>t.y&&n.y<t.y+t.h});return i.length&&i.filter(function(n){return n.x+n.w===t.x}).length&&i.filter(function(n){return n.x===t.x+t.w}).length?!1:n.findIndex(function(n){return n.visible&&n.z===t.z+1&&s(n,t)})>=0?!1:!0}),t=Array.from(i.getElementsByClassName("tile"));t.forEach(function(n){n.classList[r.findIndex(function(t){return t.visible&&t.index===parseInt(n.dataset.index)})>=0?"add":"remove"]("free")});t.forEach(function(t){var f=u(t),i=f?v(t):undefined,r=p(t).filter(function(n){return u(n)});t.classList[o||r.length>1?"remove":"add"]("last");t.classList[r.length&&r.findIndex(function(n){return!n.classList.contains("free")})<0?"add":"remove"]("all"),function(){if(f){var r=!0,u,e,t=n.filter(function(n){return n.index!==i.index&&n.visible&&n.z===i.z&&n.x===i.x+i.w&&n.y+n.h>i.y&&n.y<i.y+i.h});t.length&&(t.sort(function(n,t){return t.y-n.y}),u=t[0].y,t.forEach(function(n,t){r&&t>0&&n.y>u&&(r=!1);u=n.y}),r&&(t=n.filter(function(n){return n.index!==i.index&&n.visible&&n.z===i.z&&n.y===i.y+i.h&&n.x+n.w>i.x&&n.x<i.x+i.w}),t.length&&(t.sort(function(n,t){return t.x-n.x}),u=t[0].x,t.forEach(function(n,t){r&&t>0&&n.x>u&&(r=!1)}),r&&(e=n.filter(function(n){return n.visible&&n.z===i.z+1&&s(n,i)}),e.length&&d(i,e)&&nt++))))}}();!o&&t.classList.contains("sandwich")&&function(){var n,e,u,h,o;f&&(u=[],e=[],r.forEach(function(n){(s(i,v(n))?u:e).push(n)}),u.length>it[parseInt(t.dataset.type)]/2?n=!0:e.length===0&&(n=!0),n||(h=parseInt(t.dataset.type),o=!u.length));t.classList[n?"add":"remove"]("fatal");t.classList[o?"add":"remove"]("uncovered")}()})}(),function(){var t=[],r=[];o||(Array.from(i.getElementsByClassName("free")).forEach(function(i,u){var s=!0,e,h,f=p(i,!0),o=f.length;if(o){for(f.push(i),n=!0,e=0;u<o,h=f[e];e++)if(r[h.dataset.index]){s=!1;break}s&&(f.forEach(function(n){r[n.dataset.index]=!0}),t.push(f),g+=Math.floor((o+1)/2))}}),t.sort(function(n,t){var i=function(n){var t=v(n[0]);return n.length*1e9+t.z*1e6+t.y*1e3+t.x},r=i(n),u=i(t);return r<u?1:r>u?-1:0}));a=t}();i.dispatchEvent(new Event("game.changed"));i.getElementsByClassName("tile").length===i.getElementsByClassName("hidden").length?o||(o=Date.now(),i.dispatchEvent(new Event("game.won"))):(i.querySelector(".tile.fatal")||!n)&&(o||(o=Date.now(),i.dispatchEvent(new Event("game.lost"))))};return b(function(){try{it=w(l=f);Array.from(i.childNodes).forEach(function(n){n.parentElement.removeChild(n)}),function(){var r=0;l.forEach(function(u){var f=document.createElement("div"),s,e;f.classList.add("tile");f.classList.add("fade");(u.w!==1||u.h!==1)&&(f.classList.add("w-"+u.w),f.classList.add("h-"+u.h));f.style.left=u.x*n.width-u.z*n.depth+n.padding+"px";f.style.top=u.y*n.height-u.z*n.depth+n.padding+"px";f.style.zIndex=r++;f.dataset.index=u.index;f.dataset.type=u.type;f.dataset.x=u.x;f.dataset.y=u.y;f.dataset.z=u.z;f.dataset.w=u.w;f.dataset.h=u.h;f.addEventListener("click",function(){(function(n){var u=!0,r=Array.from(i.getElementsByClassName("clicked")),f=Array.from(i.getElementsByClassName("matching"));(n.classList.contains("free")||o)&&(f.forEach(function(n){n.classList.remove("matching")}),r.length===1&&r[0]!==n&&r[0].dataset.type===n.dataset.type?(t(r[0]),t(n),r[0].classList.remove("clicked"),n.classList.remove("clicked"),h.push([r[0],n]),tt||(tt=Date.now()),k()):o?(t(n),n.classList.remove("clicked"),h.push([n]),k()):(r.forEach(function(t){t!==n&&t.classList.remove("clicked")}),n.classList.toggle("clicked"),n.classList.contains("clicked")&&(u=!n.classList.contains("hint"),p(n).forEach(function(n){n.classList.add("matching")}))),u&&(c=undefined,Array.from(i.getElementsByClassName("hint")).forEach(function(n){n.classList.remove("hint")})))})(this)});s=document.createElement("div");s.classList.add("face");s.classList.add("t"+u.face);(u.w!==1||u.h!==1)&&(s.style.backgroundPosition=u.background.x*u.w+"px "+u.background.y*u.h+"px");y&&(e=document.createElement("span"),e.style.color="red",e.style.fontSize="7pt",e.style.fontWeight="bold",e.style.pointerEvents="none",e.innerText=[u.index,u.x,u.y,u.z].join(", "),s.appendChild(e));f.appendChild(s);i.appendChild(f);u.tile=f}),function(){l.forEach(function(n){p(n.tile).filter(function(t){return s(v(t),n)}).forEach(function(n){n.classList.add("sandwich")})})}();k()}();e&&e()}catch(r){i.dispatchEvent(new Event("game.wrong"))}}),{get availableMoves(){return g},board:{get width(){return l?l.width:0},get height(){return l?l.height:0}},get constants(){return n},get end(){return o},get hiddenTiles(){return nt},get hints(){return a},get history(){return h},nextHint:function(){var n;Array.from(i.getElementsByClassName("hint")).forEach(function(n){n.classList.remove("hint")});typeof c!="undefined"&&c===a.length-1&&(c=undefined);a.length&&(n=typeof c!="undefined"?c+1:0,a[n].forEach(function(n){n.classList.add("hint")}),c=n)},get start(){return tt},undo:function(n){h.length&&(Array.from(i.querySelectorAll(".clicked, .matching")).forEach(function(n){n.classList.remove("clicked");n.classList.remove("matching")}),o&&(n||h[h.length-1].length>1)&&(o=undefined),(n?h:[h.pop()]).forEach(function(n){n.forEach(function(n){r(n)})}),n&&h.length&&h.splice(0,h.length),c=undefined,k())},get visibleTiles(){return i.querySelectorAll(".tile:not(.hidden)").length}}}})(),function(){var e=document.querySelector(".board"),s=document.getElementById("menu"),o=document.getElementById("message"),y=document.querySelector(".scaler"),l=document.querySelector(".status");(function(){typeof ShadowRoot=="undefined"&&(o.classList.add("compatible"),s.classList.add("compatible"));c("animate")&&document.querySelector("body").classList.add("animate")})();var i,f,d,it=function(){r(s);r(messageBackdrop)},nt=function(){u(o)?(w(),b()):i&&i.history.length?v(document.getElementById("askNewMessage").value):b()},rt=function(){v(document.getElementById("restartMessage").value)},ut=function(){f=document.getElementById("mapList").querySelector("input[type=radio]:checked").value;try{window.sessionStorage&&window.sessionStorage.setItem&&window.sessionStorage.setItem("mahJong-map",f)}catch(n){}b()},p=function(){g&&g();Array.from(document.querySelectorAll(".undo, .restart")).forEach(function(n){i&&i.history.length?n.removeAttribute("disabled"):n.setAttribute("disabled","disabled")});Array.from(document.getElementsByClassName("hint")).forEach(function(n){!i||i.end?n.setAttribute("disabled","disabled"):n.removeAttribute("disabled")});document.getElementById("tiles").innerText=i?i.visibleTiles.toLocaleString():"";document.getElementById("availableMoves").innerText=i?i.availableMoves.toLocaleString():"";document.getElementById("hiddenTiles").innerText=i?i.hiddenTiles.toLocaleString():""},w=function(){t(o);t(s);t(document.getElementById("messageBackdrop"))},b=function(){f&&(i&&(i=undefined,e.removeEventListener("game.changed",p)),i=new a(e,new window.maps[f],function(){e.addEventListener("game.changed",p);setTimeout(function(){d();p()})}))},tt=function(){i.nextHint()},g=function(){var n=0,t,r="";i&&i.start&&(n=(i.end||Date.now())-i.start);n=Math.floor(n/1e3);n>=3600&&(r=Math.floor(n/3600)+":",n%=3600);t=Math.floor(n/60);n%=60;r.length&&t<10&&(t="0"+t);r+=t+":";n<10&&(n="0"+n);document.getElementById("time").innerText=r+n},ft=function(){k(!0)},v=function(n){document.getElementById("messageText").innerText=n;r(document.getElementById("messageBackdrop"));r(o)},k=function(n){i.undo(n);p()};(function(){e.addEventListener("game.changed",p);e.addEventListener("game.won",function(){v(document.getElementById("wonMessage").value)});e.addEventListener("game.lost",function(){v(document.getElementById("lostMessage").value)});e.addEventListener("game.wrong",function(){v(document.getElementById("wrongGameMessage").value)});n(l,"newGame",nt);n(l,"undo",function(){k()});n(l,"hint",tt);n(l,"restart",rt);n(l,"map",it);document.getElementById("messageBackdrop").addEventListener("click",function(){w()});h(o,"button",w);n(o,"newGame",b);n(o,"restart",ft);h(s,"button",w);n(s,"accept",ut),function(){var t,i,n;if((t=window.maps)&&(n=Object.keys(t)).length){try{window.sessionStorage&&window.sessionStorage.getItem&&(f=window.sessionStorage.getItem("mahJong-map"))}catch(r){}f&&n.indexOf(f)<0&&(f=undefined);f=f||n[0]}n&&n.length>1?(i=document.getElementById("mapList"),Array.from(i.childNodes).forEach(function(n){n.parentElement.removeChild(n)}),n.forEach(function(n){var e=document.createElement("li"),u=document.createElement("label"),r=document.createElement("input"),o=document.createTextNode(t[n].displayName);u.addEventListener("dblclick",function(n){n.which===1&&s.querySelector(".accept").click()});r.setAttribute("name","map");r.setAttribute("type","radio");r.value=n;n===f&&r.setAttribute("checked","checked");u.appendChild(r);u.appendChild(o);e.appendChild(u);i.appendChild(e)})):l.querySelector(".map").style.display="none"}()})();document.addEventListener("keydown",function(n){switch(n.which){case 27:w();break;case 68:v((new Date).toLocaleString());break;case 72:tt();break;case 90:n.ctrlKey&&k();break;case 113:nt();break;case 221:n.ctrlKey&&k(!0)}});(d=function(){if(i){var t=(window.innerWidth-2*i.constants.padding)/i.board.width,r=(window.innerHeight-2*i.constants.padding)/i.board.height,n=1;e.clientHeight&&((t<1||r<1)&&(n=Math.min(t,r)),y.style["-ms-transform"]=y.style["-moz-transform"]=y.style["-o-transform"]=y.style["-webkit-transform"]=y.style.transform=n<1?"scale("+n+")":"")}})();window.addEventListener("resize",d);window.setInterval(g,100);document.addEventListener("DOMContentLoaded",b)}()})()