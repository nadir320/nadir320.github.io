"use strict";(function(){var p="map-style",h="mahjong-game-state",f="sessionStorage",e=Array.prototype.slice.call(window.document.getElementsByTagName("script")).pop();(function(){Array.prototype.findIndex||(Array.prototype.findIndex=function(n){for(var i=this,t=0,r=this.length;t<r;t++)if(n.call(i,this[t],t))return t;return-1});Array.from||(Array.from=function(n){for(var i=[],t=0,r=n.length;t<r;t++)i.push(n[t]);return i});var n=e.getAttribute("storage");n&&n.length&&(f=n+"Storage")})();var c=function(n,t){Array.from(typeof n.length!="undefined"?n:[n]).forEach(function(n){n.addEventListener("click",t)})},n=function(n,t,i){c(n.querySelectorAll("."+t),i)},l=function(n,t,i){c(n.getElementsByTagName(t),i)},g=function(n){var t={};return Object.keys(n).forEach(function(i){t[i]=n[i]}),t},t=function(n){n.classList.add("hidden")},u=function(n){return!n.classList.contains("hidden")},i=function(n){for(var t=undefined,i,r=0,u=n.length;r<u;r++)i=n[r],t=t===undefined?i:Math.max(t,i);return t},o=function(n){for(var t=undefined,i,r=0,u=n.length;r<u;r++)i=n[r],t=t===undefined?i:Math.min(t,i);return t},a=function(n){return Object.keys(s()).findIndex(function(t){return t.toLowerCase()===n.toLowerCase()})>=0},s=function(n){var t=(n=n||window.location.href).indexOf("?"),i={};return t>=0&&(n=n.substr(t+1),t=n.indexOf("#"),t>=0&&(n=n.substr(0,t)),n.split("&").forEach(function(n){var t=n.indexOf("="),r=n.substr(0,t),u=n.substr(t+1);i[r||u]=r?window.decodeURIComponent(u):undefined})),i},w=function(n){var i,t;try{if(i=window[f],i&&(t=i.getItem(n),t&&t.length))return window.JSON.parse(t)}catch(r){}},v=function(n,t){var i;t&&(i=document.getElementById(t))?i.innerText=n:(i=document.createElement("style"),i.setAttribute("type","text/css"),t&&i.setAttribute("id",t),i.innerText=n,document.querySelector("head").appendChild(i))},r=function(n){n.classList.remove("hidden")},b=function(n,t){n.completed?t():n.executing?n.callbacks.push(t):(n.callbacks=[t],n.executing=!0,n(function(){n.completed=!0;n.executing=!1;for(var t=0,i=n.callbacks.length;t<i;t++)n.callbacks[t]()}))},k=function(n,t){try{var i=window[f];i&&(typeof t!="undefined"?i.setItem(n,window.JSON.stringify(t)):i.removeItem(n))}catch(r){}},d=a("debug"),y;(function(){var n={get depth(){return 6},get padding(){return 8}},f,l=function(t,i){var o=document.createElement("canvas"),u,f=t+n.depth,e=i+n.depth,r;return o.setAttribute("width",f),o.setAttribute("height",e),r=o.getContext("2d"),r.fillStyle="",u=r.createLinearGradient(0,i,0,e),u.addColorStop(0,"rgba(0, 0, 0, 0.25)"),u.addColorStop(1,"rgba(0, 0, 0, 0.75)"),r.fillStyle=u,r.beginPath(),r.moveTo(0,i),r.lineTo(n.depth,e),r.lineTo(f,e),r.lineTo(t,i),r.closePath(),r.fill(),u=r.createLinearGradient(t,0,f,0),u.addColorStop(0,"rgba(0, 0, 0, 0.25)"),u.addColorStop(1,"rgba(0, 0, 0, 0.75)"),r.fillStyle=u,r.beginPath(),r.moveTo(t,0),r.lineTo(t,i),r.lineTo(f,e),r.lineTo(f,n.depth),r.closePath(),r.fill(),o.toDataURL()},w=function(n){b(g,n)},g=function(t){var i=new Image,r;i.onload=function(){var y=this.width/9,p=this.height/5;Object.defineProperty(n,"width",{get:function(){return y}});Object.defineProperty(n,"height",{get:function(){return p}});var e,w="polygon("+n.width+"px 0, 100% "+n.depth+"px, 100% 100%, "+n.depth+"px 100%, 0 "+n.height+"px, 0 0)",h,i,r,o,u,c,s=0,a=0;for(e=['.face { background-image: url("'+this.src+'") !important; width: '+n.width+"px; height: "+n.height+"px; }",".tile { width: "+(n.width+n.depth)+"px; height: "+(n.height+n.depth)+"px; background-image: url("+l(n.width,n.height)+"); background-repeat: no-repeat; "+["","ms","moz","o","webkit"].map(function(n){return(n?"-"+n+"-":"")+"clip-path: "+w}).join("; ")+"}"],f=[],i=0;i<5;i++)for(h=i===3?8:i===4?7:9,r=0;r<h;r++){for(e.push(".t"+s+"{ background-position: -"+n.width*r+"px -"+n.height*i+"px }"),u=i>2&&r<4?1:4,(u!==1||c!==u)&&a++,o=0;o<u;o++)f.push({background:{x:-(n.width*r),y:-(n.height*i)},face:s,index:f.length,type:a});s++;c=u}v(e.join("\n"));t()};r=e.getAttribute("palette")||s(e.getAttribute("src")).palette||s(window.location.href).palette;i.src=r},nt=function(n,t){var i=[],r,f,u,e;for(t.forEach(function(t){i.push({x:t.x,y:n.y,w:t.w,h:n.h});i.push({x:n.x,y:t.y,w:n.w,h:t.h})}),r=0;f=i[r];r++)for(u=0;e=t[u];u++)if(!tt(f,e))return!1;return!0},a=function(t,r){var w=o(t.map(function(n){return n.x})),d=i(t.map(function(n){return n.x+n.w})),b=o(t.map(function(n){return n.y})),g=i(t.map(function(n){return n.y+n.h})),k=o(t.map(function(n){return n.z})),nt=i(t.map(function(n){return n.z})),tt=i(t.map(function(n){return n.w})),it=i(t.map(function(n){return n.h})),e=d-w,s=g-b,h=t.length%4,y,u;return h?(function(){var i=t.slice(),n;i.sort(function(n,t){return t.z-n.z});h=i.slice(0,h);n=t.filter(function(n){return h.findIndex(function(t){return t===n})<0});n.splice(0,0,0,t.length);t.splice.apply(t,n)}(),a(t)):((w!==0||b!==0)&&t.forEach(function(n){n.x-=w;n.y-=b}),k!==0&&t.forEach(function(n){n.z-=k}),e*=n.width,e+=n.depth,e+=2*n.padding,t.width=e,s*=n.height,s+=n.depth,s+=2*n.padding,t.height=s,y=[".wrapper { max-width: "+e+"px; max-height:"+s+"px; }",".board { width: "+e+"px; height: "+s+"px; }"],function(){for(var t,u,r,i=1;i<=tt;i++)for(t=1;t<=it;t++)(i!==1||t!==1)&&(r=[],r.push('background-image: url("'+l(n.width*i,n.height*t)+'")'),r.push("width: "+(i*n.width+n.depth)+"px"),r.push("height: "+(t*n.height+n.depth)+"px"),r.push("clip-path: polygon("+i*n.width+"px 0, 100% "+n.depth+"px, 100% 100%, "+n.depth+"px 100%, 0 "+t*n.height+"px, 0 0)"),y.push(".tile.w-"+i+".h-"+t+" { "+r.join("; ")+" }"),u=[],u.push("background-size: "+n.width*9*i+"px "+n.height*5*t+"px"),u.push("width: "+i*n.width+"px"),u.push("height: "+t*n.height+"px"),y.push(".tile.w-"+i+".h-"+t+" .face { "+u.join("; ")+" }"))}(),v(y.join("\n"),p),r?function(){var a=0,s,e=t.findIndex(function(n){return typeof n.faceIndex!="undefined"})<0,o=e?"type":"faceIndex",i,n,v,r,h,l;do{if(n=f.slice(),h={},a++,e){while(t.length<n.length)i=Math.floor(Math.random()*n.length),i=n[i].type,v=h[i]?0:2,h[i]=!0,r=0,n=n.filter(function(n){return n.type!==i||r++<v});while(t.length>n.length)i=Math.floor(Math.random()*n.length),i=n[i].type,r=n.length,s=n.filter(function(n){return n.type===i}).slice(0,2).map(function(n){return{background:{x:n.background.x,y:n.background.y},face:n.face,index:r++,type:n.type}}),s.splice(0,0,0,0),n.splice.apply(n,s);l=n}else l=t;u={};l.forEach(function(n){typeof u[n[o]]!="undefined"?u[n[o]]++:u[n[o]]=1});t.forEach(function(t,i){t.index=i;var u=e?Math.floor(Math.random()*n.length):t.faceIndex,r=n[u];t.background=r.background;t.face=r.face;t.type=r.type;e&&n.splice(u,1)})}while(function(){var n,e,s,h,r,f,i;for(r=t.filter(function(n){return n.z}),n=0,s=r.length;n<s;n++)for(f=r[n],h=u[f[o]]/2,e=0,i=k;i<=nt;i++)if(i!==f.z&&t.findIndex(function(t){return t.z===i&&t.type===f.type&&c(r[n],t)})>=0&&++e>=h){if(a>Math.pow(t.length,2))throw new Error;return!0}}())}():(u={},f.forEach(function(n){typeof u[n.type]!="undefined"?u[n.type]++:u[n.type]=1})),u)},tt=function(n,t){return t.x<=n.x&&t.x+t.w>=n.x+n.w&&t.y<=n.y&&t.y+t.h>=n.y+n.h},c=function(n,t){return n!==t&&n.y+n.h>t.y&&n.y<t.y+t.h&&n.x+n.w>t.x&&n.x<t.x+t.w};y=function(i,f,e,o){var rt=0,s,ut=0,v,p=[],l=[],b,y,ft,it=function(n,t){var r=n.dataset.type;return Array.from(i.getElementsByClassName("tile")).filter(function(i){return i!==n&&i.dataset.type===r&&(!t||i.classList.contains("free"))})},g=function(n){return{index:parseInt(n.dataset.index),x:parseFloat(n.dataset.x),y:parseFloat(n.dataset.y),z:parseFloat(n.dataset.z),w:parseFloat(n.dataset.w),h:parseFloat(n.dataset.h)}},tt=function(){var n;rt=0;ut=0,function(){var n=Array.from(i.getElementsByClassName("tile")).map(function(n){var t=g(n);return t.index=parseInt(n.dataset.index),t.visible=u(n),t}),r=n.filter(function(t){var i=n.filter(function(n){return n.index!==t.index&&n.visible&&n.z===t.z&&n.y+n.h>t.y&&n.y<t.y+t.h});return i.length&&i.filter(function(n){return n.x+n.w===t.x}).length&&i.filter(function(n){return n.x===t.x+t.w}).length?!1:n.findIndex(function(n){return n.visible&&n.z===t.z+1&&c(n,t)})>=0?!1:!0}),t=Array.from(i.getElementsByClassName("tile"));t.forEach(function(n){n.classList[r.findIndex(function(t){return t.visible&&t.index===parseInt(n.dataset.index)})>=0?"add":"remove"]("free")});t.forEach(function(t){var f=u(t),i=f?g(t):undefined,r=it(t).filter(function(n){return u(n)});t.classList[s||r.length>1?"remove":"add"]("last");t.classList[r.length&&r.findIndex(function(n){return!n.classList.contains("free")})<0?"add":"remove"]("all"),function(){if(f){var r=!0,u,e,t=n.filter(function(n){return n.index!==i.index&&n.visible&&n.z===i.z&&n.x===i.x+i.w&&n.y+n.h>i.y&&n.y<i.y+i.h});t.length&&(t.sort(function(n,t){return t.y-n.y}),u=t[0].y,t.forEach(function(n,t){r&&t>0&&n.y>u&&(r=!1);u=n.y}),r&&(t=n.filter(function(n){return n.index!==i.index&&n.visible&&n.z===i.z&&n.y===i.y+i.h&&n.x+n.w>i.x&&n.x<i.x+i.w}),t.length&&(t.sort(function(n,t){return t.x-n.x}),u=t[0].x,t.forEach(function(n,t){r&&t>0&&n.x>u&&(r=!1)}),r&&(e=n.filter(function(n){return n.visible&&n.z===i.z+1&&c(n,i)}),e.length&&nt(i,e)&&ut++))))}}();!s&&t.classList.contains("sandwich")&&function(){var n,e,u,s,o;f&&(u=[],e=[],r.forEach(function(n){(c(i,g(n))?u:e).push(n)}),u.length>ft[parseInt(t.dataset.type)]/2?n=!0:e.length===0&&(n=!0),n||(s=parseInt(t.dataset.type),o=!u.length));t.classList[n?"add":"remove"]("fatal");t.classList[o?"add":"remove"]("uncovered")}()})}(),function(){var t=[],r=[];s||(Array.from(i.getElementsByClassName("free")).forEach(function(i,u){var s=!0,e,h,f=it(i,!0),o=f.length;if(o){for(f.push(i),n=!0,e=0;u<o,h=f[e];e++)if(r[h.dataset.index]){s=!1;break}s&&(f.forEach(function(n){r[n.dataset.index]=!0}),t.push(f),rt+=Math.floor((o+1)/2))}}),t.sort(function(n,t){var i=function(n){var t=g(n[0]);return n.length*1e9+t.z*1e6+t.y*1e3+t.x},r=i(n),u=i(t);return r<u?1:r>u?-1:0}));p=t}();i.dispatchEvent(new Event("game.changed"));i.getElementsByClassName("tile").length===i.getElementsByClassName("hidden").length?s||(s=Date.now(),i.dispatchEvent(new Event("game.won"))):(i.querySelector(".tile.fatal")||!n)&&(s||(s=Date.now(),i.dispatchEvent(new Event("game.lost"))))};return w(function(){try{o&&(s=o.end,v=o.hintIndex,b=o.start,f=o.tileSet);ft=a(y=f,!o);Array.from(i.childNodes).forEach(function(n){n.parentElement.removeChild(n)}),function(){var r=0;y.forEach(function(u){var f=document.createElement("div"),o,e;f.classList.add("tile");f.classList.add("fade");(u.w!==1||u.h!==1)&&(f.classList.add("w-"+u.w),f.classList.add("h-"+u.h));f.style.left=u.x*n.width-u.z*n.depth+n.padding+"px";f.style.top=u.y*n.height-u.z*n.depth+n.padding+"px";f.style.zIndex=r++;f.dataset.index=u.index;f.dataset.type=u.type;f.dataset.x=u.x;f.dataset.y=u.y;f.dataset.z=u.z;f.dataset.w=u.w;f.dataset.h=u.h;f.addEventListener("click",function(){(function(n){var u=!0,r=Array.from(i.getElementsByClassName("clicked")),f=Array.from(i.getElementsByClassName("matching"));(n.classList.contains("free")||s)&&(f.forEach(function(n){n.classList.remove("matching")}),r.length===1&&r[0]!==n&&r[0].dataset.type===n.dataset.type?(t(r[0]),t(n),r[0].classList.remove("clicked"),n.classList.remove("clicked"),l.push([r[0],n]),b||(b=Date.now()),tt()):s?(t(n),n.classList.remove("clicked"),l.push([n]),tt()):(r.forEach(function(t){t!==n&&t.classList.remove("clicked")}),n.classList.toggle("clicked"),n.classList.contains("clicked")&&(u=!n.classList.contains("hint"),it(n).forEach(function(n){n.classList.add("matching")}))),u&&(v=undefined,Array.from(i.getElementsByClassName("hint")).forEach(function(n){n.classList.remove("hint")})))})(this)});o=document.createElement("div");o.classList.add("face");o.classList.add("t"+u.face);(u.w!==1||u.h!==1)&&(o.style.backgroundPosition=u.background.x*u.w+"px "+u.background.y*u.h+"px");d&&(e=document.createElement("span"),e.style.color="red",e.style.fontSize="7pt",e.style.fontWeight="bold",e.style.pointerEvents="none",e.innerText=[u.index,u.x,u.y,u.z].join(", "),o.appendChild(e));f.appendChild(o);i.appendChild(f);u.tile=f}),function(){y.forEach(function(n){it(n.tile).filter(function(t){return c(g(t),n)}).forEach(function(n){n.classList.add("sandwich")})})}();tt()}();o&&o.history&&o.history.length&&(l=o.history.map(function(n){return n.map(function(n){var r=i.querySelector("[data-index='"+n+"']");return t(r),r})}),tt());e&&e()}catch(r){i.dispatchEvent(new Event("game.wrong"))}}),{get availableMoves(){return rt},board:{get width(){return y?y.width:0},get height(){return y?y.height:0}},get constants(){return n},get end(){return s},get hiddenTiles(){return ut},get hints(){return p},get history(){return l},nextHint:function(){var n;Array.from(i.getElementsByClassName("hint")).forEach(function(n){n.classList.remove("hint")});typeof v!="undefined"&&v===p.length-1&&(v=undefined);p.length&&(n=typeof v!="undefined"?v+1:0,p[n].forEach(function(n){n.classList.add("hint")}),v=n)},save(){k(h,s?undefined:{hintIndex:v,history:l.map(function(n){return n.map(function(n){return parseInt(n.dataset.index)})}),start:b,tileSet:y,tilesPerType:ft})},get start(){return b},undo:function(n){l.length&&(Array.from(i.querySelectorAll(".clicked, .matching")).forEach(function(n){n.classList.remove("clicked");n.classList.remove("matching")}),s&&(n||l[l.length-1].length>1)&&(s=undefined),(n?l:[l.pop()]).forEach(function(n){n.forEach(function(n){r(n)})}),n&&l.length&&l.splice(0,l.length),v=undefined,tt())},get visibleTiles(){return i.querySelectorAll(".tile:not(.hidden)").length}}}})(),function(){var e=document.querySelector(".board"),s=document.getElementById("menu"),o=document.getElementById("message"),p=document.querySelector(".scaler"),c=document.querySelector(".status");(function(){typeof ShadowRoot=="undefined"&&(o.classList.add("compatible"),s.classList.add("compatible"));a("animate")&&document.querySelector("body").classList.add("animate")})();var i,f,nt,ut=function(){r(s);r(messageBackdrop)},it=function(){u(o)?(k(),d()):i&&i.history.length?v(document.getElementById("askNewMessage").value):d()},ft=function(){v(document.getElementById("restartMessage").value)},et=function(){f=document.getElementById("mapList").querySelector("input[type=radio]:checked").value;try{window.sessionStorage&&window.sessionStorage.setItem&&window.sessionStorage.setItem("mahJong-map",f)}catch(n){}d()},b=function(){tt&&tt();Array.from(document.querySelectorAll(".undo, .restart")).forEach(function(n){i&&i.history.length?n.removeAttribute("disabled"):n.setAttribute("disabled","disabled")});Array.from(document.getElementsByClassName("hint")).forEach(function(n){!i||i.end?n.setAttribute("disabled","disabled"):n.removeAttribute("disabled")});document.getElementById("tiles").innerText=i?i.visibleTiles.toLocaleString():"";document.getElementById("availableMoves").innerText=i?i.availableMoves.toLocaleString():"";document.getElementById("hiddenTiles").innerText=i?i.hiddenTiles.toLocaleString():"";i&&i.save()},k=function(){t(o);t(s);t(document.getElementById("messageBackdrop"))},d=function(n){f&&(i&&(i=undefined,e.removeEventListener("game.changed",b)),i=new y(e,new window.maps[f],function(){e.addEventListener("game.changed",b);setTimeout(function(){nt();b()})},n))},rt=function(){i.nextHint()},tt=function(){var n=0,t,r="";i&&i.start&&(n=(i.end||Date.now())-i.start);n=Math.floor(n/1e3);n>=3600&&(r=Math.floor(n/3600)+":",n%=3600);t=Math.floor(n/60);n%=60;r.length&&t<10&&(t="0"+t);r+=t+":";n<10&&(n="0"+n);document.getElementById("time").innerText=r+n},ot=function(){g(!0)},v=function(n){document.getElementById("messageText").innerText=n;r(document.getElementById("messageBackdrop"));r(o)},g=function(n){i.undo(n);b()};(function(){e.addEventListener("game.changed",b);e.addEventListener("game.won",function(){v(document.getElementById("wonMessage").value)});e.addEventListener("game.lost",function(){v(document.getElementById("lostMessage").value)});e.addEventListener("game.wrong",function(){v(document.getElementById("wrongGameMessage").value)});n(c,"newGame",it);n(c,"undo",function(){g()});n(c,"hint",rt);n(c,"restart",ft);n(c,"map",ut);document.getElementById("messageBackdrop").addEventListener("click",function(){k()});l(o,"button",k);n(o,"newGame",function(){d()});n(o,"restart",ot);l(s,"button",k);n(s,"accept",et),function(){var t,i,n;if((t=window.maps)&&(n=Object.keys(t)).length){try{window.sessionStorage&&window.sessionStorage.getItem&&(f=window.sessionStorage.getItem("mahJong-map"))}catch(r){}f&&n.indexOf(f)<0&&(f=undefined);f=f||n[0]}n&&n.length>1?(i=document.getElementById("mapList"),Array.from(i.childNodes).forEach(function(n){n.parentElement.removeChild(n)}),n.forEach(function(n){var e=document.createElement("li"),u=document.createElement("label"),r=document.createElement("input"),o=document.createTextNode(t[n].displayName);u.addEventListener("dblclick",function(n){n.which===1&&s.querySelector(".accept").click()});r.setAttribute("name","map");r.setAttribute("type","radio");r.value=n;n===f&&r.setAttribute("checked","checked");u.appendChild(r);u.appendChild(o);e.appendChild(u);i.appendChild(e)})):c.querySelector(".map").style.display="none"}()})();document.addEventListener("keydown",function(n){switch(n.which){case 27:k();break;case 68:v((new Date).toLocaleString());break;case 72:rt();break;case 90:n.ctrlKey&&g();break;case 113:it();break;case 221:n.ctrlKey&&g(!0)}});(nt=function(){if(i){var t=(window.innerWidth-2*i.constants.padding)/i.board.width,r=(window.innerHeight-2*i.constants.padding)/i.board.height,n=1;e.clientHeight&&((t<1||r<1)&&(n=Math.min(t,r)),p.style["-ms-transform"]=p.style["-moz-transform"]=p.style["-o-transform"]=p.style["-webkit-transform"]=p.style.transform=n<1?"scale("+n+")":"")}})();window.addEventListener("resize",nt);window.setInterval(tt,100);document.addEventListener("DOMContentLoaded",function(){d(w(h))})}()})()