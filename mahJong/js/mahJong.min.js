"use strict";(function(){var h="mahjong-map-name",k="map-style",c="mahjong-game-state",u="session",e=Array.prototype.slice.call(window.document.getElementsByTagName("script")).pop();(function(){Array.prototype.findIndex||(Array.prototype.findIndex=function(n){for(var i=this,t=0,r=this.length;t<r;t++)if(n.call(i,this[t],t))return t;return-1});Array.from||(Array.from=function(n){for(var i=[],t=0,r=n.length;t<r;t++)i.push(n[t]);return i});var n=e.getAttribute("storage");n&&n.length&&(u=n);u+="Storage"})();var l=function(n,t){Array.from(typeof n.length!="undefined"?n:[n]).forEach(function(n){n.addEventListener("click",t)})},n=function(n,t,i){l(n.querySelectorAll("."+t),i)},a=function(n,t,i){l(n.getElementsByTagName(t),i)},it=function(n){var t={};return Object.keys(n).forEach(function(i){t[i]=n[i]}),t},t=function(n){n.classList.add("hidden")},f=function(n){return!n.classList.contains("hidden")},i=function(n){for(var t=undefined,i,r=0,u=n.length;r<u;r++)i=n[r],t=t===undefined?i:Math.max(t,i);return t},o=function(n){for(var t=undefined,i,r=0,u=n.length;r<u;r++)i=n[r],t=t===undefined?i:Math.min(t,i);return t},v=function(n){return Object.keys(s()).findIndex(function(t){return t.toLowerCase()===n.toLowerCase()})>=0},s=function(n){var t=(n=n||window.location.href).indexOf("?"),i={};return t>=0&&(n=n.substr(t+1),t=n.indexOf("#"),t>=0&&(n=n.substr(0,t)),n.split("&").forEach(function(n){var t=n.indexOf("="),r=n.substr(0,t),u=n.substr(t+1);i[r||u]=r?window.decodeURIComponent(u):undefined})),i},d=function(n){var t=y(n);if(t&&t.length)try{return window.JSON.parse(t)}catch(i){}},y=function(n){try{var t=window[u];if(t&&t.getItem)return t.getItem(n)}catch(i){}},p=function(n,t){var i;t&&(i=document.getElementById(t))?i.innerText=n:(i=document.createElement("style"),i.setAttribute("type","text/css"),t&&i.setAttribute("id",t),i.innerText=n,document.querySelector("head").appendChild(i))},r=function(n){n.classList.remove("hidden")},g=function(n,t){n.completed?t():n.executing?n.callbacks.push(t):(n.callbacks=[t],n.executing=!0,n(function(){n.completed=!0;n.executing=!1;for(var t=0,i=n.callbacks.length;t<i;t++)n.callbacks[t]()}))},nt=function(n,t){typeof t!="undefined"&&(t=window.JSON.stringify(t));w(n,t)},w=function(n,t){try{var i=window[u];i&&(typeof t!="undefined"?i.setItem&&i.setItem(n,t):i.removeItem&&i.removeItem(n))}catch(r){}},tt=v("debug"),b;(function(){var n={get depth(){return 6},get padding(){return 8}},u,l=function(t,i){var o=document.createElement("canvas"),u,f=t+n.depth,e=i+n.depth,r;return o.setAttribute("width",f),o.setAttribute("height",e),r=o.getContext("2d"),r.fillStyle="",u=r.createLinearGradient(0,i,0,e),u.addColorStop(0,"rgba(0, 0, 0, 0.25)"),u.addColorStop(1,"rgba(0, 0, 0, 0.75)"),r.fillStyle=u,r.beginPath(),r.moveTo(0,i),r.lineTo(n.depth,e),r.lineTo(f,e),r.lineTo(t,i),r.closePath(),r.fill(),u=r.createLinearGradient(t,0,f,0),u.addColorStop(0,"rgba(0, 0, 0, 0.25)"),u.addColorStop(1,"rgba(0, 0, 0, 0.75)"),r.fillStyle=u,r.beginPath(),r.moveTo(t,0),r.lineTo(t,i),r.lineTo(f,e),r.lineTo(f,n.depth),r.closePath(),r.fill(),o.toDataURL()},v=function(n){g(y,n)},y=function(t){var i=new Image,r;i.onload=function(){var v=this.width/9,y=this.height/5;Object.defineProperty(n,"width",{get:function(){return v}});Object.defineProperty(n,"height",{get:function(){return y}});var e,w="polygon("+n.width+"px 0, 100% "+n.depth+"px, 100% 100%, "+n.depth+"px 100%, 0 "+n.height+"px, 0 0)",h,i,r,o,f,c,s=0,a=0;for(e=['.face { background-image: url("'+this.src+'") !important; width: '+n.width+"px; height: "+n.height+"px; }",".tile { width: "+(n.width+n.depth)+"px; height: "+(n.height+n.depth)+"px; background-image: url("+l(n.width,n.height)+"); background-repeat: no-repeat; "+["","ms","moz","o","webkit"].map(function(n){return(n?"-"+n+"-":"")+"clip-path: "+w}).join("; ")+"}"],u=[],i=0;i<5;i++)for(h=i===3?8:i===4?7:9,r=0;r<h;r++){for(e.push(".t"+s+"{ background-position: -"+n.width*r+"px -"+n.height*i+"px }"),f=i>2&&r<4?1:4,(f!==1||c!==f)&&a++,o=0;o<f;o++)u.push({background:{x:-(n.width*r),y:-(n.height*i)},face:s,index:u.length,type:a});s++;c=f}p(e.join("\n"));t()};r=e.getAttribute("palette")||s(e.getAttribute("src")).palette||s(window.location.href).palette;i.src=r},w=function(n,t){var i=[],r,f,u,e;for(t.forEach(function(t){i.push({x:t.x,y:n.y,w:t.w,h:n.h});i.push({x:n.x,y:t.y,w:n.w,h:t.h})}),r=0;f=i[r];r++)for(u=0;e=t[u];u++)if(!d(f,e))return!1;return!0},a=function(t,r){var y=o(t.map(function(n){return n.x})),d=i(t.map(function(n){return n.x+n.w})),w=o(t.map(function(n){return n.y})),g=i(t.map(function(n){return n.y+n.h})),b=o(t.map(function(n){return n.z})),nt=i(t.map(function(n){return n.z})),tt=i(t.map(function(n){return n.w})),it=i(t.map(function(n){return n.h})),e=d-y,s=g-w,c=t.length%4,v,f;return c?(function(){var i=t.slice(),n;i.sort(function(n,t){return t.z-n.z});c=i.slice(0,c);n=t.filter(function(n){return c.findIndex(function(t){return t===n})<0});n.splice(0,0,0,t.length);t.splice.apply(t,n)}(),a(t)):((y!==0||w!==0)&&t.forEach(function(n){n.x-=y;n.y-=w}),b!==0&&t.forEach(function(n){n.z-=b}),e*=n.width,e+=n.depth,e+=2*n.padding,t.width=e,s*=n.height,s+=n.depth,s+=2*n.padding,t.height=s,v=[".wrapper { max-width: "+e+"px; max-height:"+s+"px; }",".board { width: "+e+"px; height: "+s+"px; }"],function(){for(var t,u,r,i=1;i<=tt;i++)for(t=1;t<=it;t++)(i!==1||t!==1)&&(r=[],r.push('background-image: url("'+l(n.width*i,n.height*t)+'")'),r.push("width: "+(i*n.width+n.depth)+"px"),r.push("height: "+(t*n.height+n.depth)+"px"),r.push("clip-path: polygon("+i*n.width+"px 0, 100% "+n.depth+"px, 100% 100%, "+n.depth+"px 100%, 0 "+t*n.height+"px, 0 0)"),v.push(".tile.w-"+i+".h-"+t+" { "+r.join("; ")+" }"),u=[],u.push("background-size: "+n.width*9*i+"px "+n.height*5*t+"px"),u.push("width: "+i*n.width+"px"),u.push("height: "+t*n.height+"px"),v.push(".tile.w-"+i+".h-"+t+" .face { "+u.join("; ")+" }"))}(),p(v.join("\n"),k),r?function(){var a=0,s,e=t.findIndex(function(n){return typeof n.faceIndex!="undefined"})<0,o=e?"type":"faceIndex",i,n,v,r,c,l;do{if(n=u.slice(),c={},a++,e){while(t.length<n.length)i=Math.floor(Math.random()*n.length),i=n[i].type,v=c[i]?0:2,c[i]=!0,r=0,n=n.filter(function(n){return n.type!==i||r++<v});while(t.length>n.length)i=Math.floor(Math.random()*n.length),i=n[i].type,r=n.length,s=n.filter(function(n){return n.type===i}).slice(0,2).map(function(n){return{background:{x:n.background.x,y:n.background.y},face:n.face,index:r++,type:n.type}}),s.splice(0,0,0,0),n.splice.apply(n,s);l=n}else l=t;f={};l.forEach(function(n){typeof f[n[o]]!="undefined"?f[n[o]]++:f[n[o]]=1});t.forEach(function(t,i){t.index=i;var u=e?Math.floor(Math.random()*n.length):t.faceIndex,r=n[u];t.background=r.background;t.face=r.face;t.type=r.type;e&&n.splice(u,1)})}while(function(){var n,e,s,c,r,u,i;for(r=t.filter(function(n){return n.z}),n=0,s=r.length;n<s;n++)for(u=r[n],c=f[u[o]]/2,e=0,i=b;i<=nt;i++)if(i!==u.z&&t.findIndex(function(t){return t.z===i&&t.type===u.type&&h(r[n],t)})>=0&&++e>=c){if(a>Math.pow(t.length,2))throw new Error;return!0}}())}():(f={},u.forEach(function(n){typeof f[n.type]!="undefined"?f[n.type]++:f[n.type]=1})),f)},d=function(n,t){return t.x<=n.x&&t.x+t.w>=n.x+n.w&&t.y<=n.y&&t.y+t.h>=n.y+n.h},h=function(n,t){return n!==t&&n.y+n.h>t.y&&n.y<t.y+t.h&&n.x+n.w>t.x&&n.x<t.x+t.w};b=function(i,u,e,o){var rt=0,s,ut=0,y,b=[],l=[],k,p,ft,it=function(n,t){var r=n.dataset.type;return Array.from(i.getElementsByClassName("tile")).filter(function(i){return i!==n&&i.dataset.type===r&&(!t||i.classList.contains("free"))})},d=function(n){return{index:parseInt(n.dataset.index),x:parseFloat(n.dataset.x),y:parseFloat(n.dataset.y),z:parseFloat(n.dataset.z),w:parseFloat(n.dataset.w),h:parseFloat(n.dataset.h)}},g=function(){var n;rt=0;ut=0,function(){var n=Array.from(i.getElementsByClassName("tile")).map(function(n){var t=d(n);return t.index=parseInt(n.dataset.index),t.visible=f(n),t}),r=n.filter(function(t){var i=n.filter(function(n){return n.index!==t.index&&n.visible&&n.z===t.z&&n.y+n.h>t.y&&n.y<t.y+t.h});return i.length&&i.filter(function(n){return n.x+n.w===t.x}).length&&i.filter(function(n){return n.x===t.x+t.w}).length?!1:n.findIndex(function(n){return n.visible&&n.z===t.z+1&&h(n,t)})>=0?!1:!0}),t=Array.from(i.getElementsByClassName("tile"));t.forEach(function(n){n.classList[r.findIndex(function(t){return t.visible&&t.index===parseInt(n.dataset.index)})>=0?"add":"remove"]("free")});t.forEach(function(t){var u=f(t),i=u?d(t):undefined,r=it(t).filter(function(n){return f(n)});t.classList[s||r.length>1?"remove":"add"]("last");t.classList[r.length&&r.findIndex(function(n){return!n.classList.contains("free")})<0?"add":"remove"]("all"),function(){if(u){var r=!0,f,e,t=n.filter(function(n){return n.index!==i.index&&n.visible&&n.z===i.z&&n.x===i.x+i.w&&n.y+n.h>i.y&&n.y<i.y+i.h});t.length&&(t.sort(function(n,t){return t.y-n.y}),f=t[0].y,t.forEach(function(n,t){r&&t>0&&n.y>f&&(r=!1);f=n.y}),r&&(t=n.filter(function(n){return n.index!==i.index&&n.visible&&n.z===i.z&&n.y===i.y+i.h&&n.x+n.w>i.x&&n.x<i.x+i.w}),t.length&&(t.sort(function(n,t){return t.x-n.x}),f=t[0].x,t.forEach(function(n,t){r&&t>0&&n.x>f&&(r=!1)}),r&&(e=n.filter(function(n){return n.visible&&n.z===i.z+1&&h(n,i)}),e.length&&w(i,e)&&ut++))))}}();!s&&t.classList.contains("sandwich")&&function(){var n,e,f,s,o;u&&(f=[],e=[],r.forEach(function(n){(h(i,d(n))?f:e).push(n)}),f.length>ft[parseInt(t.dataset.type)]/2?n=!0:e.length===0&&(n=!0),n||(s=parseInt(t.dataset.type),o=!f.length));t.classList[n?"add":"remove"]("fatal");t.classList[o?"add":"remove"]("uncovered")}()})}(),function(){var t=[],r=[];s||(Array.from(i.getElementsByClassName("free")).forEach(function(i,u){var s=!0,e,h,f=it(i,!0),o=f.length;if(o){for(f.push(i),n=!0,e=0;u<o,h=f[e];e++)if(r[h.dataset.index]){s=!1;break}s&&(f.forEach(function(n){r[n.dataset.index]=!0}),t.push(f),rt+=Math.floor((o+1)/2))}}),t.sort(function(n,t){var i=function(n){var t=d(n[0]);return n.length*1e9+t.z*1e6+t.y*1e3+t.x},r=i(n),u=i(t);return r<u?1:r>u?-1:0}));b=t}();i.dispatchEvent(new Event("game.changed"));i.getElementsByClassName("tile").length===i.getElementsByClassName("hidden").length?s||(s=Date.now(),i.dispatchEvent(new Event("game.won"))):(i.querySelector(".tile.fatal")||!n)&&(s||(s=Date.now(),i.dispatchEvent(new Event("game.lost"))));nt(c,s?undefined:{hintIndex:y,history:l.map(function(n){return n.map(function(n){return parseInt(n.dataset.index)})}),start:k,tileSet:p,tilesPerType:ft})};return v(function(){try{o&&(s=o.end,y=o.hintIndex,k=o.start,u=o.tileSet);ft=a(p=u,!o);Array.from(i.childNodes).forEach(function(n){n.parentElement.removeChild(n)}),function(){var r=0;p.forEach(function(u){var f=document.createElement("div"),o,e;f.classList.add("tile");f.classList.add("fade");(u.w!==1||u.h!==1)&&(f.classList.add("w-"+u.w),f.classList.add("h-"+u.h));f.style.left=u.x*n.width-u.z*n.depth+n.padding+"px";f.style.top=u.y*n.height-u.z*n.depth+n.padding+"px";f.style.zIndex=r++;f.dataset.index=u.index;f.dataset.type=u.type;f.dataset.x=u.x;f.dataset.y=u.y;f.dataset.z=u.z;f.dataset.w=u.w;f.dataset.h=u.h;f.addEventListener("click",function(){(function(n){var u=!0,r=Array.from(i.getElementsByClassName("clicked")),f=Array.from(i.getElementsByClassName("matching"));(n.classList.contains("free")||s)&&(f.forEach(function(n){n.classList.remove("matching")}),r.length===1&&r[0]!==n&&r[0].dataset.type===n.dataset.type?(t(r[0]),t(n),r[0].classList.remove("clicked"),n.classList.remove("clicked"),l.push([r[0],n]),k||(k=Date.now()),g()):s?(t(n),n.classList.remove("clicked"),l.push([n]),g()):(r.forEach(function(t){t!==n&&t.classList.remove("clicked")}),n.classList.toggle("clicked"),n.classList.contains("clicked")&&(u=!n.classList.contains("hint"),it(n).forEach(function(n){n.classList.add("matching")}))),u&&(y=undefined,Array.from(i.getElementsByClassName("hint")).forEach(function(n){n.classList.remove("hint")})))})(this)});o=document.createElement("div");o.classList.add("face");o.classList.add("t"+u.face);(u.w!==1||u.h!==1)&&(o.style.backgroundPosition=u.background.x*u.w+"px "+u.background.y*u.h+"px");tt&&(e=document.createElement("span"),e.style.color="red",e.style.fontSize="7pt",e.style.fontWeight="bold",e.style.pointerEvents="none",e.innerText=[u.index,u.x,u.y,u.z].join(", "),o.appendChild(e));f.appendChild(o);i.appendChild(f);u.tile=f}),function(){p.forEach(function(n){it(n.tile).filter(function(t){return h(d(t),n)}).forEach(function(n){n.classList.add("sandwich")})})}();g()}();o&&o.history&&o.history.length&&(l=o.history.map(function(n){return n.map(function(n){var r=i.querySelector("[data-index='"+n+"']");return t(r),r})}),g());e&&e()}catch(r){i.dispatchEvent(new Event("game.wrong"))}}),{get availableMoves(){return rt},board:{get width(){return p?p.width:0},get height(){return p?p.height:0}},get constants(){return n},get end(){return s},get hiddenTiles(){return ut},get hints(){return b},get history(){return l},nextHint:function(){var n;Array.from(i.getElementsByClassName("hint")).forEach(function(n){n.classList.remove("hint")});typeof y!="undefined"&&y===b.length-1&&(y=undefined);b.length&&(n=typeof y!="undefined"?y+1:0,b[n].forEach(function(n){n.classList.add("hint")}),y=n)},get start(){return k},undo:function(n){l.length&&(Array.from(i.querySelectorAll(".clicked, .matching")).forEach(function(n){n.classList.remove("clicked");n.classList.remove("matching")}),s&&(n||l[l.length-1].length>1)&&(s=undefined),(n?l:[l.pop()]).forEach(function(n){n.forEach(function(n){r(n)})}),n&&l.length&&l.splice(0,l.length),y=undefined,g())},get visibleTiles(){return i.querySelectorAll(".tile:not(.hidden)").length}}}})(),function(){var e=document.querySelector(".board"),s=document.getElementById("menu"),o=document.getElementById("message"),k=document.querySelector(".scaler"),l=document.querySelector(".status");(function(){typeof ShadowRoot=="undefined"&&(o.classList.add("compatible"),s.classList.add("compatible"));v("animate")&&document.querySelector("body").classList.add("animate")})();var i,u,rt,ot=function(){r(s);r(messageBackdrop)},ft=function(){f(o)?(nt(),tt()):i&&i.history.length?p(document.getElementById("askNewMessage").value):tt()},st=function(){p(document.getElementById("restartMessage").value)},ht=function(){u=document.getElementById("mapList").querySelector("input[type=radio]:checked").value;w(h,u);tt()},g=function(){ut&&ut();Array.from(document.querySelectorAll(".undo, .restart")).forEach(function(n){i&&i.history.length?n.removeAttribute("disabled"):n.setAttribute("disabled","disabled")});Array.from(document.getElementsByClassName("hint")).forEach(function(n){!i||i.end?n.setAttribute("disabled","disabled"):n.removeAttribute("disabled")});document.getElementById("tiles").innerText=i?i.visibleTiles.toLocaleString():"";document.getElementById("availableMoves").innerText=i?i.availableMoves.toLocaleString():"";document.getElementById("hiddenTiles").innerText=i?i.hiddenTiles.toLocaleString():""},nt=function(){t(o);t(s);t(document.getElementById("messageBackdrop"))},tt=function(n){u&&(i&&(i=undefined,e.removeEventListener("game.changed",g)),i=new b(e,new window.maps[u],function(){e.addEventListener("game.changed",g);setTimeout(function(){rt();g()})},n))},et=function(){i.nextHint()},ut=function(){var n=0,t,r="";i&&i.start&&(n=(i.end||Date.now())-i.start);n=Math.floor(n/1e3);n>=3600&&(r=Math.floor(n/3600)+":",n%=3600);t=Math.floor(n/60);n%=60;r.length&&t<10&&(t="0"+t);r+=t+":";n<10&&(n="0"+n);document.getElementById("time").innerText=r+n},ct=function(){it(!0)},p=function(n){document.getElementById("messageText").innerText=n;r(document.getElementById("messageBackdrop"));r(o)},it=function(n){i.undo(n);g()};(function(){e.addEventListener("game.changed",g);e.addEventListener("game.won",function(){p(document.getElementById("wonMessage").value)});e.addEventListener("game.lost",function(){p(document.getElementById("lostMessage").value)});e.addEventListener("game.wrong",function(){p(document.getElementById("wrongGameMessage").value)});n(l,"newGame",ft);n(l,"undo",function(){it()});n(l,"hint",et);n(l,"restart",st);n(l,"map",ot);document.getElementById("messageBackdrop").addEventListener("click",function(){nt()});a(o,"button",nt);n(o,"newGame",function(){tt()});n(o,"restart",ct);a(s,"button",nt);n(s,"accept",ht),function(){var t,i,n;(t=window.maps)&&(n=Object.keys(t)).length&&((u=y(h))&&n.indexOf(u)<0&&(u=undefined),u=u||n[0]);n&&n.length>1?(i=document.getElementById("mapList"),Array.from(i.childNodes).forEach(function(n){n.parentElement.removeChild(n)}),n.forEach(function(n){var e=document.createElement("li"),f=document.createElement("label"),r=document.createElement("input"),o=document.createTextNode(t[n].displayName);f.addEventListener("dblclick",function(n){n.which===1&&s.querySelector(".accept").click()});r.setAttribute("name","map");r.setAttribute("type","radio");r.value=n;n===u&&r.setAttribute("checked","checked");f.appendChild(r);f.appendChild(o);e.appendChild(f);i.appendChild(e)})):l.querySelector(".map").style.display="none"}()})();document.addEventListener("keydown",function(n){switch(n.which){case 27:nt();break;case 68:p((new Date).toLocaleString());break;case 72:et();break;case 90:n.ctrlKey&&it();break;case 113:ft();break;case 221:n.ctrlKey&&it(!0)}});(rt=function(){if(i){var t=(window.innerWidth-2*i.constants.padding)/i.board.width,r=(window.innerHeight-2*i.constants.padding)/i.board.height,n=1;e.clientHeight&&((t<1||r<1)&&(n=Math.min(t,r)),k.style["-ms-transform"]=k.style["-moz-transform"]=k.style["-o-transform"]=k.style["-webkit-transform"]=k.style.transform=n<1?"scale("+n+")":"")}})();window.addEventListener("resize",rt);window.setInterval(ut,100);document.addEventListener("DOMContentLoaded",function(){tt(d(c))})}()})()