"use strict";(function(){(function(){Array.prototype.findIndex||(Array.prototype.findIndex=function(n){for(var i=this,t=0,r=this.length;t<r;t++)if(n.call(i,this[t],t))return t;return-1});Array.from||(Array.from=function(n){for(var i=[],t=0,r=n.length;t<r;t++)i.push(n[t]);return i})})();var e=function(n,t){Array.from(typeof n.length!="undefined"?n:[n]).forEach(function(n){n.addEventListener("click",t)})},n=function(n,t,i){e(n.querySelectorAll("."+t),i)},o=function(n,t,i){e(n.getElementsByTagName(t),i)},y=function(n){var t={};return Object.keys(n).forEach(function(i){t[i]=n[i]}),t},t=function(n){n.classList.add("hidden")},u=function(n){return!n.classList.contains("hidden")},i=function(n){for(var t=undefined,i,r=0,u=n.length;r<u;r++)i=n[r],t=t===undefined?i:Math.max(t,i);return t},f=function(n){for(var t=undefined,i,r=0,u=n.length;r<u;r++)i=n[r],t=t===undefined?i:Math.min(t,i);return t},s=function(n){return Object.keys(h()).findIndex(function(t){return t.toLowerCase()===n.toLowerCase()})>=0},h=function(n){var t=(n=n||window.location.href).indexOf("?"),i={};return t>=0&&(n=n.substr(t+1),t=n.indexOf("#"),t>=0&&(n=n.substr(0,t)),n.split("&").forEach(function(n){var t=n.indexOf("="),r=n.substr(0,t),u=n.substr(t+1);i[r||u]=r?window.decodeURIComponent(u):undefined})),i},c=function(n,t){var i;t&&(i=document.getElementById(t))?i.innerText=n:(i=document.createElement("style"),i.setAttribute("type","text/css"),t&&i.setAttribute("id",t),i.innerText=n,document.querySelector("head").appendChild(i))},r=function(n){n.classList.remove("hidden")},a=function(n,t){n.completed?t():n.executing?n.callbacks.push(t):(n.callbacks=[t],n.executing=!0,n(function(){n.completed=!0;n.executing=!1;for(var t=0,i=n.callbacks.length;t<i;t++)n.callbacks[t]()}))},v=s("debug"),l;(function(){var n={get depth(){return 6},get padding(){return 8}},o,s=function(t,i){var o=document.createElement("canvas"),u,f=t+n.depth,e=i+n.depth,r;return o.setAttribute("width",f),o.setAttribute("height",e),r=o.getContext("2d"),r.fillStyle="",u=r.createLinearGradient(0,i,0,e),u.addColorStop(0,"rgba(0, 0, 0, 0.25)"),u.addColorStop(1,"rgba(0, 0, 0, 0.75)"),r.fillStyle=u,r.beginPath(),r.moveTo(0,i),r.lineTo(n.depth,e),r.lineTo(f,e),r.lineTo(t,i),r.closePath(),r.fill(),u=r.createLinearGradient(t,0,f,0),u.addColorStop(0,"rgba(0, 0, 0, 0.25)"),u.addColorStop(1,"rgba(0, 0, 0, 0.75)"),r.fillStyle=u,r.beginPath(),r.moveTo(t,0),r.lineTo(t,i),r.lineTo(f,e),r.lineTo(f,n.depth),r.closePath(),r.fill(),o.toDataURL()},p=function(n){a(w,n)},w=function(t){var r=new Image,i,u;r.onload=function(){var y=this.width/9,p=this.height/5;Object.defineProperty(n,"width",{get:function(){return y}});Object.defineProperty(n,"height",{get:function(){return p}});var f,w="polygon("+n.width+"px 0, 100% "+n.depth+"px, 100% 100%, "+n.depth+"px 100%, 0 "+n.height+"px, 0 0)",l,i,r,e,u,a,h=0,v=0;for(f=['.face { background-image: url("'+this.src+'") !important; width: '+n.width+"px; height: "+n.height+"px; }",".tile { width: "+(n.width+n.depth)+"px; height: "+(n.height+n.depth)+"px; background-image: url("+s(n.width,n.height)+"); background-repeat: no-repeat; "+["","ms","moz","o","webkit"].map(function(n){return(n?"-"+n+"-":"")+"clip-path: "+w}).join("; ")+"}"],o=[],i=0;i<5;i++)for(l=i===3?8:i===4?7:9,r=0;r<l;r++){for(f.push(".t"+h+"{ background-position: -"+n.width*r+"px -"+n.height*i+"px }"),u=i>2&&r<4?1:4,(u!==1||a!==u)&&v++,e=0;e<u;e++)o.push({background:{x:-(n.width*r),y:-(n.height*i)},face:h,index:o.length,type:v});h++;a=u}c(f.join("\n"));t()};i=Array.prototype.slice.call(window.document.getElementsByTagName("script")).pop();u=i.getAttribute("palette")||h(i.getAttribute("src")).palette;r.src=u},b=function(n,t){var i=[],r,f,u,e;for(t.forEach(function(t){i.push({x:t.x,y:n.y,w:t.w,h:n.h});i.push({x:n.x,y:t.y,w:n.w,h:t.h})}),r=0;f=i[r];r++)for(u=0;e=t[u];u++)if(!k(f,e))return!1;return!0},y=function(t){var v=f(t.map(function(n){return n.x})),b=i(t.map(function(n){return n.x+n.w})),p=f(t.map(function(n){return n.y})),k=i(t.map(function(n){return n.y+n.h})),w=f(t.map(function(n){return n.z})),d=i(t.map(function(n){return n.z})),g=i(t.map(function(n){return n.w})),nt=i(t.map(function(n){return n.h})),r=b-v,u=k-p,l=t.length%4,a,h;return l?(function(){var i=t.slice(),n;i.sort(function(n,t){return t.z-n.z});l=i.slice(0,l);n=t.filter(function(n){return l.findIndex(function(t){return t===n})<0});n.splice(0,0,0,t.length);t.splice.apply(t,n)}(),y(t)):((v!==0||p!==0)&&t.forEach(function(n){n.x-=v;n.y-=p}),w!==0&&t.forEach(function(n){n.z-=w}),r*=n.width,r+=n.depth,r+=2*n.padding,t.width=r,u*=n.height,u+=n.depth,u+=2*n.padding,t.height=u,a=[".wrapper { max-width: "+r+"px; max-height:"+u+"px; }",".board { width: "+r+"px; height: "+u+"px; }"],function(){for(var t,u,r,i=1;i<=g;i++)for(t=1;t<=nt;t++)(i!==1||t!==1)&&(r=[],r.push('background-image: url("'+s(n.width*i,n.height*t)+'")'),r.push("width: "+(i*n.width+n.depth)+"px"),r.push("height: "+(t*n.height+n.depth)+"px"),r.push("clip-path: polygon("+i*n.width+"px 0, 100% "+n.depth+"px, 100% 100%, "+n.depth+"px 100%, 0 "+t*n.height+"px, 0 0)"),a.push(".tile.w-"+i+".h-"+t+" { "+r.join("; ")+" }"),u=[],u.push("background-size: "+n.width*9*i+"px "+n.height*5*t+"px"),u.push("width: "+i*n.width+"px"),u.push("height: "+t*n.height+"px"),a.push(".tile.w-"+i+".h-"+t+" .face { "+u.join("; ")+" }"))}(),c(a.join("\n"),"map-style"),function(){var u,i,n,s,r,f;do{for(n=o.slice(),f={},h={};t.length<n.length;)i=Math.floor(Math.random()*n.length),i=n[i].type,s=f[i]?0:2,f[i]=!0,r=0,n=n.filter(function(n){return n.type!==i||r++<s});while(t.length>n.length)i=Math.floor(Math.random()*n.length),i=n[i].type,r=n.length,u=n.filter(function(n){return n.type===i}).slice(0,2).map(function(n){return{background:{x:n.background.x,y:n.background.y},face:n.face,index:r++,type:n.type}}),u.splice(0,0,0,0),n.splice.apply(n,u);n.forEach(function(n){typeof h[n.type]!="undefined"?h[n.type]++:h[n.type]=1});t.forEach(function(t,i){t.index=i;var u=Math.floor(Math.random()*n.length),r=n[u];t.background=r.background;t.face=r.face;t.type=r.type;n.splice(u,1)})}while(function(){var n,f,o,s,r,u,i;for(r=t.filter(function(n){return n.z}),n=0,o=r.length;n<o;n++)for(u=r[n],s=h[u.type]/2,f=0,i=w;i<=d;i++)if(i!==u.z&&t.findIndex(function(t){return t.z===i&&t.type===u.type&&e(r[n],t)})>=0&&++f>=s)return!0}())}(),h)},k=function(n,t){return t.x<=n.x&&t.x+t.w>=n.x+n.w&&t.y<=n.y&&t.y+t.h>=n.y+n.h},e=function(n,t){return n!==t&&n.y+n.h>t.y&&n.y<t.y+t.h&&n.x+n.w>t.x&&n.x<t.x+t.w};l=function(i,f,o){var g=0,s,nt=0,c,a=[],h=[],tt,l,it,k=function(n,t){var r=n.dataset.type;return Array.from(i.getElementsByClassName("tile")).filter(function(i){return i!==n&&i.dataset.type===r&&(!t||i.classList.contains("free"))})},w=function(n){return{index:parseInt(n.dataset.index),x:parseFloat(n.dataset.x),y:parseFloat(n.dataset.y),z:parseFloat(n.dataset.z),w:parseFloat(n.dataset.w),h:parseFloat(n.dataset.h)}},d=function(){var n;g=0;nt=0,function(){var n=Array.from(i.getElementsByClassName("tile")).map(function(n){var t=w(n);return t.index=parseInt(n.dataset.index),t.visible=u(n),t}),r=n.filter(function(t){var i=n.filter(function(n){return n.index!==t.index&&n.visible&&n.z===t.z&&n.y+n.h>t.y&&n.y<t.y+t.h});return i.length&&i.filter(function(n){return n.x+n.w===t.x}).length&&i.filter(function(n){return n.x===t.x+t.w}).length?!1:n.findIndex(function(n){return n.visible&&n.z===t.z+1&&e(n,t)})>=0?!1:!0}),t=Array.from(i.getElementsByClassName("tile"));t.forEach(function(n){n.classList[r.findIndex(function(t){return t.visible&&t.index===parseInt(n.dataset.index)})>=0?"add":"remove"]("free")});t.forEach(function(t){var f=u(t),i=f?w(t):undefined,r=k(t).filter(function(n){return u(n)});t.classList[s||r.length>1?"remove":"add"]("last");t.classList[r.length&&r.findIndex(function(n){return!n.classList.contains("free")})<0?"add":"remove"]("all"),function(){if(f){var r=!0,u,o,t=n.filter(function(n){return n.index!==i.index&&n.visible&&n.z===i.z&&n.x===i.x+i.w&&n.y+n.h>i.y&&n.y<i.y+i.h});t.length&&(t.sort(function(n,t){return t.y-n.y}),u=t[0].y,t.forEach(function(n,t){r&&t>0&&n.y>u&&(r=!1);u=n.y}),r&&(t=n.filter(function(n){return n.index!==i.index&&n.visible&&n.z===i.z&&n.y===i.y+i.h&&n.x+n.w>i.x&&n.x<i.x+i.w}),t.length&&(t.sort(function(n,t){return t.x-n.x}),u=t[0].x,t.forEach(function(n,t){r&&t>0&&n.x>u&&(r=!1)}),r&&(o=n.filter(function(n){return n.visible&&n.z===i.z+1&&e(n,i)}),o.length&&b(i,o)&&nt++))))}}();t.classList.contains("sandwich")&&function(){var n,u,o,c,l;f&&!s&&(o=[],u=[],r.forEach(function(n){(e(i,w(n))?o:u).push(n)}),o.length>it[parseInt(t.dataset.type)]/2?n=!0:u.length===0&&(n=!0),n||(c=parseInt(t.dataset.type),l=h.findIndex(function(n){return parseInt(n[0].dataset.type)===c})>=0));t.classList[n?"add":"remove"]("fatal");t.classList[l?"add":"remove"]("uncovered")}()})}(),function(){var t=[],r=[];s||(Array.from(i.getElementsByClassName("free")).forEach(function(i,u){var s=!0,o,h,f=k(i,!0),e=f.length;if(e){for(f.push(i),n=!0,o=0;u<e,h=f[o];o++)if(r[h.dataset.index]){s=!1;break}s&&(f.forEach(function(n){r[n.dataset.index]=!0}),t.push(f),g+=1+(e===1?0:e))}}),t.sort(function(n,t){var i=function(n){var t=w(n[0]);return n.length*1e9+t.z*1e6+t.y*1e3+t.x},r=i(n),u=i(t);return r<u?1:r>u?-1:0}));a=t}();i.dispatchEvent(new Event("game.changed"));i.getElementsByClassName("tile").length===i.getElementsByClassName("hidden").length?s||(s=Date.now(),i.dispatchEvent(new Event("game.won"))):(i.querySelector(".tile.fatal")||!n)&&(s||(s=Date.now(),i.dispatchEvent(new Event("game.lost"))))};return p(function(){it=y(l=f);Array.from(i.childNodes).forEach(function(n){n.parentElement.removeChild(n)}),function(){var r=0;l.forEach(function(u){var f=document.createElement("div"),o,e;f.classList.add("tile");f.classList.add("fade");(u.w!==1||u.h!==1)&&(f.classList.add("w-"+u.w),f.classList.add("h-"+u.h));f.style.left=u.x*n.width-u.z*n.depth+n.padding+"px";f.style.top=u.y*n.height-u.z*n.depth+n.padding+"px";f.style.zIndex=r++;f.dataset.index=u.index;f.dataset.type=u.type;f.dataset.x=u.x;f.dataset.y=u.y;f.dataset.z=u.z;f.dataset.w=u.w;f.dataset.h=u.h;f.addEventListener("click",function(){(function(n){var u=!0,r=Array.from(i.getElementsByClassName("clicked")),f=Array.from(i.getElementsByClassName("matching"));(n.classList.contains("free")||s)&&(f.forEach(function(n){n.classList.remove("matching")}),r.length===1&&r[0]!==n&&r[0].dataset.type===n.dataset.type?(t(r[0]),t(n),r[0].classList.remove("clicked"),n.classList.remove("clicked"),h.push([r[0],n]),tt||(tt=Date.now()),d()):s?(t(n),n.classList.remove("clicked"),h.push([n]),d()):(r.forEach(function(t){t!==n&&t.classList.remove("clicked")}),n.classList.toggle("clicked"),n.classList.contains("clicked")&&(u=!n.classList.contains("hint"),k(n).forEach(function(n){n.classList.add("matching")}))),u&&(c=undefined,Array.from(i.getElementsByClassName("hint")).forEach(function(n){n.classList.remove("hint")})))})(this)});o=document.createElement("div");o.classList.add("face");o.classList.add("t"+u.face);(u.w!==1||u.h!==1)&&(o.style.backgroundPosition=u.background.x*u.w+"px "+u.background.y*u.h+"px");v&&(e=document.createElement("span"),e.style.color="red",e.style.fontSize="7pt",e.style.fontWeight="bold",e.style.pointerEvents="none",e.innerText=[u.index,u.x,u.y,u.z].join(", "),o.appendChild(e));f.appendChild(o);i.appendChild(f);u.tile=f}),function(){l.forEach(function(n){k(n.tile).filter(function(t){return e(w(t),n)}).forEach(function(n){n.classList.add("sandwich")})})}();d()}();o&&o()}),{get availableMoves(){return g},board:{get width(){return l?l.width:0},get height(){return l?l.height:0}},get constants(){return n},get end(){return s},get hiddenTiles(){return nt},get hints(){return a},get history(){return h},nextHint:function(){var n;Array.from(i.getElementsByClassName("hint")).forEach(function(n){n.classList.remove("hint")});typeof c!="undefined"&&c===a.length-1&&(c=undefined);a.length&&(n=typeof c!="undefined"?c+1:0,a[n].forEach(function(n){n.classList.add("hint")}),c=n)},get start(){return tt},undo:function(n){h.length&&(Array.from(i.querySelectorAll(".clicked, .matching")).forEach(function(n){n.classList.remove("clicked");n.classList.remove("matching")}),s&&(n||h[h.length-1].length>1)&&(s=undefined),(n?h:[h.pop()]).forEach(function(n){n.forEach(function(n){r(n)})}),n&&h.length&&h.splice(0,h.length),c=undefined,d())},get visibleTiles(){return i.querySelectorAll(".tile:not(.hidden)").length}}}})(),function(){var e=document.querySelector(".board"),c=document.getElementById("menu"),h=document.getElementById("message"),v=document.querySelector(".scaler"),a=document.querySelector(".status");(function(){typeof ShadowRoot=="undefined"&&(h.classList.add("compatible"),c.classList.add("compatible"));s("animate")&&document.querySelector("body").classList.add("animate")})();var i,f,d,it=function(){r(c);r(messageBackdrop)},nt=function(){u(h)?(p(),w()):i.history.length?b(document.getElementById("askNewMessage").value):w()},rt=function(){b(document.getElementById("restartMessage").value)},ut=function(){f=document.getElementById("mapList").querySelector("input[type=radio]:checked").value;try{window.sessionStorage&&window.sessionStorage.setItem&&window.sessionStorage.setItem("mahJong-map",f)}catch(n){}w()},y=function(){g&&g();Array.from(document.querySelectorAll(".undo, .restart")).forEach(function(n){i&&i.history.length?n.removeAttribute("disabled"):n.setAttribute("disabled","disabled")});Array.from(document.getElementsByClassName("hint")).forEach(function(n){!i||i.end?n.setAttribute("disabled","disabled"):n.removeAttribute("disabled")});document.getElementById("tiles").innerText=i?i.visibleTiles.toLocaleString():"";document.getElementById("availableMoves").innerText=i?i.availableMoves.toLocaleString():"";document.getElementById("hiddenTiles").innerText=i?i.hiddenTiles.toLocaleString():""},p=function(){t(h);t(c);t(document.getElementById("messageBackdrop"))},w=function(){f&&(i&&(i=undefined,e.removeEventListener("game.changed",y)),i=new l(e,new window.maps[f],function(){e.addEventListener("game.changed",y);setTimeout(function(){d();y()})}))},tt=function(){i.nextHint()},g=function(){var n=0,t,r="";i&&i.start&&(n=(i.end||Date.now())-i.start);n=Math.floor(n/1e3);n>=3600&&(r=Math.floor(n/3600)+":",n%=3600);t=Math.floor(n/60);n%=60;r.length&&t<10&&(t="0"+t);r+=t+":";n<10&&(n="0"+n);document.getElementById("time").innerText=r+n},ft=function(){k(!0)},b=function(n){document.getElementById("messageText").innerText=n;r(document.getElementById("messageBackdrop"));r(h)},k=function(n){i.undo(n);y()};(function(){e.addEventListener("game.changed",y);e.addEventListener("game.won",function(){b(document.getElementById("wonMessage").value)});e.addEventListener("game.lost",function(){b(document.getElementById("lostMessage").value)});n(a,"newGame",nt);n(a,"undo",function(){k()});n(a,"hint",tt);n(a,"restart",rt);n(a,"map",it);document.getElementById("messageBackdrop").addEventListener("click",function(){p()});o(h,"button",p);n(h,"newGame",w);n(h,"restart",ft);o(c,"button",p);n(c,"accept",ut),function(){var t,i,n;if((t=window.maps)&&(n=Object.keys(t)).length){try{window.sessionStorage&&window.sessionStorage.getItem&&(f=window.sessionStorage.getItem("mahJong-map"))}catch(r){}f&&n.indexOf(f)<0&&(f=undefined);f=f||n[0]}n&&n.length>1?(i=document.getElementById("mapList"),Array.from(i.childNodes).forEach(function(n){n.parentElement.removeChild(n)}),n.forEach(function(n){var e=document.createElement("li"),u=document.createElement("label"),r=document.createElement("input"),o=document.createTextNode(t[n].displayName);u.addEventListener("dblclick",function(n){n.which===1&&c.querySelector(".accept").click()});r.setAttribute("name","map");r.setAttribute("type","radio");r.value=n;n===f&&r.setAttribute("checked","checked");u.appendChild(r);u.appendChild(o);e.appendChild(u);i.appendChild(e)})):a.querySelector(".map").style.display="none"}()})();document.addEventListener("keydown",function(n){switch(n.which){case 27:p();break;case 68:b((new Date).toLocaleString());break;case 72:tt();break;case 90:n.ctrlKey&&k();break;case 113:nt();break;case 221:n.ctrlKey&&k(!0)}});(d=function(){if(i){var t=(window.innerWidth-2*i.constants.padding)/i.board.width,r=(window.innerHeight-2*i.constants.padding)/i.board.height,n=1;e.clientHeight&&((t<1||r<1)&&(n=Math.min(t,r)),v.style["-ms-transform"]=v.style["-moz-transform"]=v.style["-o-transform"]=v.style["-webkit-transform"]=v.style.transform=n<1?"scale("+n+")":"")}})();window.addEventListener("resize",d);window.setInterval(g,100);document.addEventListener("DOMContentLoaded",w)}()})()