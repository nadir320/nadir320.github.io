"use strict";(function(){var h="tetris-game-state",i="session",y=Array.prototype.slice.call(window.document.getElementsByTagName("script")).pop();(function(){Array.prototype.findIndex||(Array.prototype.findIndex=function(n){for(var i=this,t=0,r=this.length;t<r;t++)if(n.call(i,this[t],t))return t;return-1});Array.from||(Array.from=function(n){for(var i=[],t=0,r=n.length;t<r;t++)i.push(n[t]);return i});var n=y.getAttribute("storage");n&&n.length&&(i=n);i+="Storage"})();var c=function(n,t){Array.from(typeof n.length!="undefined"?n:[n]).forEach(function(n){n.addEventListener("click",t)})},u=function(n,t,i){c(n.querySelectorAll("."+t),i)},l=function(n,t,i){c(n.getElementsByTagName(t),i)},f=function(n){Array.from(n.childNodes).forEach(function(n){n.parentElement.removeChild(n)})},d=function(n){var t={};return Object.keys(n).forEach(function(i){t[i]=n[i]}),t},e=function(n){n.classList.add("hidden")},o=function(n){return!n.classList.contains("hidden")},t=function(n){for(var t=undefined,i,r=0,u=n.length;r<u;r++)i=n[r],t=t===undefined?i:Math.max(t,i);return t},n=function(n){for(var t=undefined,i,r=0,u=n.length;r<u;r++)i=n[r],t=t===undefined?i:Math.min(t,i);return t},s=function(n){return Object.keys(a()).findIndex(function(t){return t.toLowerCase()===n.toLowerCase()})>=0},a=function(n){var t=(n=n||window.location.href).indexOf("?"),i={};return t>=0&&(n=n.substr(t+1),t=n.indexOf("#"),t>=0&&(n=n.substr(0,t)),n.split("&").forEach(function(n){var t=n.indexOf("="),r=n.substr(0,t),u=n.substr(t+1);i[r||u]=r?window.decodeURIComponent(u):undefined})),i},p=function(n){var t=w(n);if(t&&t.length)try{return window.JSON.parse(t)}catch(i){}},w=function(n){try{var t=window[i];if(t&&t.getItem)return t.getItem(n)}catch(r){}},g=function(n,t){var i;t&&(i=document.getElementById(t))?i.innerText=n:(i=document.createElement("style"),i.setAttribute("type","text/css"),t&&i.setAttribute("id",t),i.innerText=n,document.querySelector("head").appendChild(i))},v=function(n){n.classList.remove("hidden")},nt=function(n,t){n.completed?t():n.executing?n.callbacks.push(t):(n.callbacks=[t],n.executing=!0,n(function(){n.completed=!0;n.executing=!1;for(var t=0,i=n.callbacks.length;t<i;t++)n.callbacks[t]()}))},b=function(n,t){typeof t!="undefined"&&(t=window.JSON.stringify(t));k(n,t)},k=function(n,t){try{var r=window[i];r&&(typeof t!="undefined"?r.setItem&&r.setItem(n,t):r.removeItem&&r.removeItem(n))}catch(u){}},tt=s("debug"),r;(function(){var i={get baseMoveTime(){return 500},get boardHeight(){return 20},get boardWidth(){return 10},get linesPerLevel(){return 10},get moveTimeStep(){return 50},get padding(){return 8},get randomTiles(){return 4},get tileHeight(){return 30},get tileWidth(){return 30}},u={I:{name:"I",basePosition:[[0,0],[0,1],[0,2],[0,3]]},J:{name:"J",basePosition:[[0,0],[0,1],[0,2],[1,2]]},L:{name:"L",basePosition:[[0,0],[0,1],[0,2],[1,0]]},O:{name:"O",basePosition:[[0,0],[0,1],[1,0],[1,1]]},S:{name:"S",basePosition:[[1,0],[1,1],[0,1],[0,2]]},T:{name:"T",basePosition:[[0,0],[0,1],[0,2],[1,1]]},Z:{name:"Z",basePosition:[[0,0],[0,1],[1,1],[1,2]]}},o=function(){var n=Object.keys(u);return u[n[Math.floor(Math.random()*n.length)]]},s=function(n,t,i){var r;switch(n){case"I":switch(i){case 0:case 2:r=[[t[0][0]+2,t[0][1]+-2],[t[1][0]+1,t[1][1]+-1],[t[2][0]+0,t[2][1]+0],[t[3][0]+-1,t[3][1]+1],];break;case 1:case 3:r=[[t[0][0]+-2,t[0][1]+2],[t[1][0]+-1,t[1][1]+1],[t[2][0]+0,t[2][1]+0],[t[3][0]+1,t[3][1]+-1],]}break;case"J":switch(i){case 0:r=[[t[0][0]+-1,t[0][1]+-1],[t[1][0]+0,t[1][1]+0],[t[2][0]+1,t[2][1]+1],[t[3][0]+2,t[3][1]+0],];break;case 1:r=[[t[0][0]+-1,t[0][1]+1],[t[1][0]+0,t[1][1]+0],[t[2][0]+1,t[2][1]+-1],[t[3][0]+0,t[3][1]+-2],];break;case 2:r=[[t[0][0]+1,t[0][1]+1],[t[1][0]+0,t[1][1]+0],[t[2][0]+-1,t[2][1]+-1],[t[3][0]+-2,t[3][1]+-0],];break;case 3:r=[[t[0][0]+1,t[0][1]+-1],[t[1][0]+0,t[1][1]+0],[t[2][0]+-1,t[2][1]+1],[t[3][0]+0,t[3][1]+2],]}break;case"L":switch(i){case 0:r=[[t[0][0]+-1,t[0][1]+-1],[t[1][0]+0,t[1][1]+0],[t[2][0]+1,t[2][1]+1],[t[3][0]+0,t[3][1]+-2],];break;case 1:r=[[t[0][0]+-1,t[0][1]+1],[t[1][0]+0,t[1][1]+0],[t[2][0]+1,t[2][1]+-1],[t[3][0]+-2,t[3][1]+0],];break;case 2:r=[[t[0][0]+1,t[0][1]+1],[t[1][0]+0,t[1][1]+0],[t[2][0]+-1,t[2][1]+-1],[t[3][0]+0,t[3][1]+2],];break;case 3:r=[[t[0][0]+1,t[0][1]+-1],[t[1][0]+0,t[1][1]+0],[t[2][0]+-1,t[2][1]+1],[t[3][0]+2,t[3][1]+0],]}break;case"O":r=t;break;case"S":switch(i){case 0:case 2:r=[[t[0][0]+0,t[0][1]+-2],[t[1][0]+1,t[1][1]+-1],[t[2][0]+0,t[2][1]+0],[t[3][0]+1,t[3][1]+1],];break;case 1:case 3:r=[[t[0][0]+0,t[0][1]+2],[t[1][0]+-1,t[1][1]+1],[t[2][0]+0,t[2][1]+0],[t[3][0]+-1,t[3][1]+-1],]}break;case"T":switch(i){case 0:r=[[t[0][0]+-1,t[0][1]+-1],[t[1][0]+0,t[1][1]+0],[t[2][0]+1,t[2][1]+1],[t[3][0]+1,t[3][1]+-1],];break;case 1:r=[[t[0][0]+-1,t[0][1]+1],[t[1][0]+0,t[1][1]+0],[t[2][0]+1,t[2][1]+-1],[t[3][0]+-1,t[3][1]+-1],];break;case 2:r=[[t[0][0]+1,t[0][1]+1],[t[1][0]+0,t[1][1]+0],[t[2][0]+-1,t[2][1]+-1],[t[3][0]+-1,t[3][1]+1],];break;case 3:r=[[t[0][0]+1,t[0][1]+-1],[t[1][0]+0,t[1][1]+0],[t[2][0]+-1,t[2][1]+1],[t[3][0]+1,t[3][1]+1],]}break;case"Z":switch(i){case 0:case 2:r=[[t[0][0]+-1,t[0][1]+-1],[t[1][0]+0,t[1][1]+0],[t[2][0]+1,t[2][1]+-1],[t[3][0]+2,t[3][1]+0],];break;case 1:case 3:r=[[t[0][0]+1,t[0][1]+1],[t[1][0]+0,t[1][1]+0],[t[2][0]+-1,t[2][1]+1],[t[3][0]+-2,t[3][1]+0],]}}return r},e;Object.keys(u).forEach(function(n){u[n].rotate=function(t,i){return s(n,t,i)}});e=function(r){var h,c=0,e,f,s=function(n){return(n||f).map(function(n){return n[1]})},y=function(n){return(n||f).map(function(n){return n[0]})},v=function(n){var t=f.filter(function(n){return n[0]>=0}).map(function(t){return n.apply(this,t)});t.filter(function(n){return!n}).length&&(e=!0)},l=r?u[r]:o(),a;return h=l.name,f=l.basePosition,a=function(i,r){var u=s(i),f=Math.floor((r-t(u)-n(u)+1)/2)-1;return f&&(i=i.map(function(n){return[n[0],n[1]+f]})),i},f=a(f,i.boardWidth),{className:h,createPreview:function(){for(var f,r,o=a(u[h].basePosition,4),c=s(o),l=y(o),v=n(c),p=n(l),b=t(c)-v+1,k=t(l)-p+1,w=document.createElement("div"),e=0;e<k;e++)for(f=0;f<b;f++)o.filter(function(n){return n[0]===e+p&&n[1]===f+v}).length&&(r=document.createElement("div"),r.classList.add(h),r.style.gridColumn=f+1,r.style.gridRow=e+1,r.style.width=i.tileWidth+"px",r.style.height=i.tileHeight+"px",w.appendChild(r));return w},drop:function(){var t=this,n;e||(n=t.getShadow(),n&&(f=n),v(this.findEmptyTiles))},getShadow:function(){var t=this,i=n(f.map(function(n){return t.findEmptyTiles.apply(t,n)}));if(i)return f.map(function(n){return[n[0]+i,n[1]]})},get locked(){return e},isTileVisible:function(n){return f[n][0]>=0},moveDown:function(){v(this.findEmptyTiles);e||(f=f.map(function(n){return[n[0]+1,n[1]]}))},moveLeft:function(){if(!e){var t=this,i=n(s());i>0&&f.filter(function(n){return!t.isTileFree(n[0],n[1]-1)}).length===0&&(f=f.map(function(n){return[n[0],n[1]-1]}))}},moveRight:function(){if(!e){var n=this,r=t(s());r<i.boardWidth-1&&f.filter(function(t){return!n.isTileFree(t[0],t[1]+1)}).length===0&&(f=f.map(function(n){return[n[0],n[1]+1]}))}},rotate:function(){if(!e){var u=(c+1)%4,r=l.rotate(f,u),o=s(r),h=this;n(o)>=0&&t(o)<i.boardWidth&&r.filter(function(n){return n[0]>=0&&!h.isTileFree.apply(this,n)}).length===0&&(c=u,f=r)}},get rotation(){return c},get tiles(){return f}}};r=function(n,t,r){var p,c,w,nt,g,k,tt,v,it={},a=t&&t.paused,l,et=0,rt=0,s,ut;Object.keys(u).forEach(function(n){var t=u[n];it[t.name]=0});var ot=function(n,t){return n+"°"+t},y=function(){if(d(),s&&s.locked){w=Date.now();s.tiles.forEach(function(n,t){if(s.isTileVisible(t)){var i=st.apply(this,n);i.className=s.className;i.locked=!0}});var r=Object.keys(l).map(n=>l[n]).reduce(function(n,t){return(n[t.row]||(n[t.row]=function(){var n=[];return n.row=t.row,n}())).push(t),n},[]),t=r.filter(function(n){return n.filter(function(n){return n.className}).length==i.boardWidth}).map(function(n){return n.row});t.length&&(function(){var i=0,n;for(console.log(t.length+" filled"),t.sort(function(n,t){return t-n}),n=t[0];n>=0;n--){while(t.includes(n-i))console.log("line "+n+" is filled"),i++;console.log("moving row "+(n-i)+" to row "+n+" ("+i+" rows down)");r[n].forEach(function(t){var u=n-i>=0?r[n-i].filter(function(n){return n.column===t.column}).pop():{};t.className=u.className;t.locked=u.locked;t.baseTile&&(t.baseTile=!1,rt--)})}}(),Math.floor(k/i.linesPerLevel)!==Math.floor((k+t.length)/i.linesPerLevel)&&(nt++,g=Math.max(i.moveTimeStep,g-i.moveTimeStep)),k+=t.length,d());ft();n.dispatchEvent(new Event("game.changed"));c&&n.dispatchEvent(new Event("game.lost"))}b(h,c?undefined:{start:p})},ct=function(n,t){var r=Object.keys(l).map(function(n){return l[n]}).filter(function(i){return i.column==t&&!i.className&&i.row>n}).map(function(n){return n.row}),i;for(r.sort(function(n,t){return n-t}),i=0;i<r.length;i++)if(r[i]!==n+i+1)return i;return r.length},st=function(n,t){return l[ot(n,t)]},ft=function(){var n=function(){var n=new e;return n.findEmptyTiles=ct,n.isTileFree=ht,n};v||(v=n());s=v;it[s.className]++;tt++;v=n();d();v.tiles.filter(function(n){return!ht.apply(this,n)}).length>0&&(c=Date.now(),d())},ht=function(n,t){return n<0||!st(n,t).className},d=function(){Object.keys(l).forEach(function(n){var r=l[n],i=r.tile.classList;i.remove("I");i.remove("J");i.remove("L");i.remove("O");i.remove("S");i.remove("T");i.remove("Z");i.remove("locked");i.remove("base-tile");i.remove("shadow");i.add(r.className);r.locked&&i.add("locked");r.baseTile&&i.add("base-tile");s&&function(){var u,n;s.tiles.forEach(function(n){n[0]===r.row&&n[1]===r.column&&(i.add(s.className),u=!0)});t&&t.shadow&&!u&&(n=s.getShadow(),n&&n.forEach(function(n){n[0]===r.row&&n[1]===r.column&&i.add("shadow")}))}()})};return function(){f(n);n.style.padding=i.padding+"px";n.style.width=i.tileWidth*i.boardWidth+2*i.padding+"px";n.style.height=i.tileHeight*i.boardHeight+2*i.padding+"px";var u=document.createElement("div");u.classList.add("level-container");l={},function(){for(var r,n,t=0;t<i.boardHeight;t++)for(r=0;r<i.boardWidth;r++)n=document.createElement("div"),n.classList.add("tile"),n.classList.add("fade"),n.style.gridColumn=r+1,n.style.gridRow=t+1,n.style.width=i.tileWidth+"px",n.style.height=i.tileHeight+"px",u.appendChild(n),l[ot(t,r)]={row:t,column:r,tile:n}}();t&&t.lines>0&&function(){for(var n,f,r,e=Math.min(t.lines,i.boardHeight-4),u=0;u<e;u++)for(n=Object.keys(l).map(function(n){return l[n]}).filter(function(n){return n.row===i.boardHeight-u-1}),f=0;f<i.randomTiles;f++)r=Math.floor(Math.random()*n.length),n[r].className=o().name,n[r].baseTile=!0,n.splice(r,1),et++,rt++}();n.appendChild(u);nt=1;tt=k=0;g=i.baseMoveTime;d();a||(p=Date.now(),ft());r&&r();ut=window.setInterval(function(){if(!c&&!a){p||(p=Date.now(),ft(),n.dispatchEvent(new Event("game.changed")));var t=Date.now();(!w||t-w>=g)&&(w&&s.moveDown(),w=t,y())}},50)}(),{get baseLines(){return et/i.randomTiles},board:{get width(){return i.boardWidth*i.tileWidth},get height(){return i.boardHeight*i.tileHeight}},get constants(){return i},dropPiece:function(){a||c||!s||(s.drop(),y())},get end(){return c},getNextPiecePreview:function(){if(v)return v.createPreview()},get level(){return nt},get lines(){return k},movePieceDown:function(){a||c||!s||(s.moveDown(),y())},movePieceLeft:function(){a||c||!s||(s.moveLeft(),y())},movePieceRight:function(){a||c||!s||(s.moveRight(),y())},pause:function(){a=!0},get paused(){return a},get pieces(){return tt},get pieceStats(){return it},get remainingBaseLines(){return rt/i.randomTiles},resume:function(){a=!1},rotatePiece:function(){a||c||!s||(s.rotate(),y())},get start(){return p},stop:function(){c=Date.now();window.clearInterval(ut);ut=undefined}}};r.createPreviews=function(){return Object.keys(u).map(function(n){var t=u[n];return{name:t.name,preview:new e(t.name).createPreview()}})}})(),function(){var t=document.querySelector(".board"),d=document.getElementById("menu"),i=document.getElementById("message"),y=document.querySelector(".scaler"),it=document.querySelector(".status");(function(){typeof ShadowRoot=="undefined"&&(i.classList.add("compatible"),d.classList.add("compatible"));s("animate")&&document.querySelector("body").classList.add("animate")})();var n,g,rt=function(n){Array.from(n.getElementsByTagName("div")).forEach(function(n){n.parentElement&&n.classList.add("tile")})},ut=function(){o(i)?(c(),w()):n?b(document.getElementById("askNewMessage").value):w()},k=function(){tt&&tt();Array.from(document.getElementsByClassName("level")).forEach(function(t){t.innerText=n?n.level:undefined});Array.from(document.getElementsByClassName("lines")).forEach(function(t){t.innerText=n?n.lines:undefined});Array.from(document.getElementsByClassName("pieces")).forEach(function(t){t.innerText=n?n.pieces:undefined});Array.from(document.getElementsByClassName("base-lines")).forEach(function(t){t.innerText=n?n.remainingBaseLines.toLocaleString()+"/"+n.baseLines.toLocaleString():undefined});Array.from(document.getElementsByClassName("next-piece")).forEach(function(t){var i=n?n.getNextPiecePreview():undefined;typeof i=="string"?t.setAttribute("src",i):(f(t),i&&(rt(i),t.appendChild(i)))});var t;n&&(t=n.pieceStats,Array.from(document.getElementsByClassName("piece-stats")).forEach(function(n){Array.from(n.getElementsByClassName("stat-table")).forEach(function(n){var i=Array.from(n.getElementsByClassName("stat-row"));i.forEach(function(n){Array.from(n.getElementsByClassName("stat-value")).forEach(function(i){i.innerText=t[n.dataset.type]})});i.sort(function(n,i){return t[i.dataset.type]-t[n.dataset.type]});i.forEach(function(t){n.appendChild(t)})})}))},c=function(){e(i);e(d);e(document.getElementById("messageBackdrop"))},w=function(i,u){n&&(n.stop(),n=undefined,t.removeEventListener("game.changed",k));n=new r(t,{lines:a().base||0,paused:u,shadow:s("shadow")},function(){t.addEventListener("game.changed",k);setTimeout(function(){g();k()})},i)},nt=function(){n&&(n.paused?n.resume():n.pause())},tt=function(){var t=0,i,r="";n&&n.start&&(t=(n.end||Date.now())-n.start);t=Math.floor(t/1e3);t>=3600&&(r=Math.floor(t/3600)+":",t%=3600);i=Math.floor(t/60);t%=60;r.length&&i<10&&(i="0"+i);r+=i+":";t<10&&(t="0"+t);Array.from(document.getElementsByClassName("time")).forEach(function(n){n.innerText=r+t})},b=function(t){n&&n.pause();document.getElementById("messageText").innerText=t;v(document.getElementById("messageBackdrop"));v(i)};(function(){t.addEventListener("game.changed",k);t.addEventListener("game.won",function(){b(document.getElementById("wonMessage").value)});t.addEventListener("game.lost",function(){b(document.getElementById("lostMessage").value)});t.addEventListener("game.wrong",function(){b(document.getElementById("wrongGameMessage").value)});u(it,"newGame",ut);u(it,"pauseGame",nt);document.getElementById("messageBackdrop").addEventListener("click",function(){c()});l(i,"button",c);u(i,"newGame",function(){w()});l(d,"button",c)})();document.addEventListener("keydown",function(t){switch(t.which){case 13:o(i)?(c(),w()):n&&n.dropPiece();break;case 19:case 80:nt();break;case 27:o(i)?c():nt();break;case 32:n&&n.dropPiece();break;case 37:case 65:n&&n.movePieceLeft();break;case 38:case 75:case 87:n&&n.rotatePiece();break;case 39:case 68:n&&n.movePieceRight();break;case 40:case 83:n&&n.movePieceDown();break;case 71:b((new Date).toLocaleString());break;case 113:ut()}});(g=function(){if(n){var r=(window.innerWidth-2*n.constants.padding)/n.board.width,u=(window.innerHeight-2*n.constants.padding)/n.board.height,i=1;t.clientHeight&&((r<1||u<1)&&(i=Math.min(r,u)),y.style["-ms-transform"]=y.style["-moz-transform"]=y.style["-o-transform"]=y.style["-webkit-transform"]=y.style.transform=i<1?"scale("+i+")":"")}})();window.addEventListener("resize",g);window.setInterval(tt,100);document.addEventListener("DOMContentLoaded",function(){var n=r.createPreviews();Array.from(document.getElementsByClassName("piece-stats")).forEach(function(t){f(t);var i=document.createElement("table");i.classList.add("stat-table");n.forEach(function(n){rt(n.preview);n.preview.classList.add("preview");var t=document.createElement("tr"),r=document.createElement("td");t.classList.add("stat-row");t.dataset.type=n.name;r.appendChild(n.preview);t.appendChild(r);r=document.createElement("td");r.classList.add("stat-value");t.appendChild(r);i.appendChild(t)});t.appendChild(i)});w(p(h),!0)})}()})()