"use strict";(function(){var f="tetris-game-state",n="session",v=Array.prototype.slice.call(window.document.getElementsByTagName("script")).pop();(function(){Array.prototype.findIndex||(Array.prototype.findIndex=function(n){for(var i=this,t=0,r=this.length;t<r;t++)if(n.call(i,this[t],t))return t;return-1});Array.from||(Array.from=function(n){for(var i=[],t=0,r=n.length;t<r;t++)i.push(n[t]);return i});var t=v.getAttribute("storage");t&&t.length&&(n=t);n+="Storage"})();var e=function(n,t){Array.from(typeof n.length!="undefined"?n:[n]).forEach(function(n){n.addEventListener("click",t)})},o=function(n,t,i){e(n.querySelectorAll("."+t),i)},s=function(n,t,i){e(n.getElementsByTagName(t),i)},h=function(n){Array.from(n.childNodes).forEach(function(n){n.parentElement.removeChild(n)})},d=function(n){var t={};return Object.keys(n).forEach(function(i){t[i]=n[i]}),t},i=function(n){n.classList.add("hidden")},r=function(n){return!n.classList.contains("hidden")},u=function(n){for(var t=undefined,i,r=0,u=n.length;r<u;r++)i=n[r],t=t===undefined?i:Math.max(t,i);return t},t=function(n){for(var t=undefined,i,r=0,u=n.length;r<u;r++)i=n[r],t=t===undefined?i:Math.min(t,i);return t},c=function(n){return Object.keys(y()).findIndex(function(t){return t.toLowerCase()===n.toLowerCase()})>=0},y=function(n){var t=(n=n||window.location.href).indexOf("?"),i={};return t>=0&&(n=n.substr(t+1),t=n.indexOf("#"),t>=0&&(n=n.substr(0,t)),n.split("&").forEach(function(n){var t=n.indexOf("="),r=n.substr(0,t),u=n.substr(t+1);i[r||u]=r?window.decodeURIComponent(u):undefined})),i},p=function(n){var t=w(n);if(t&&t.length)try{return window.JSON.parse(t)}catch(i){}},w=function(t){try{var i=window[n];if(i&&i.getItem)return i.getItem(t)}catch(r){}},g=function(n,t){var i;t&&(i=document.getElementById(t))?i.innerText=n:(i=document.createElement("style"),i.setAttribute("type","text/css"),t&&i.setAttribute("id",t),i.innerText=n,document.querySelector("head").appendChild(i))},l=function(n){n.classList.remove("hidden")},nt=function(n,t){n.completed?t():n.executing?n.callbacks.push(t):(n.callbacks=[t],n.executing=!0,n(function(){n.completed=!0;n.executing=!1;for(var t=0,i=n.callbacks.length;t<i;t++)n.callbacks[t]()}))},b=function(n,t){typeof t!="undefined"&&(t=window.JSON.stringify(t));k(n,t)},k=function(t,i){try{var r=window[n];r&&(typeof i!="undefined"?r.setItem&&r.setItem(t,i):r.removeItem&&r.removeItem(t))}catch(u){}},tt=c("debug"),a;(function(){var n={get baseMoveTime(){return 300},get boardHeight(){return 20},get boardWidth(){return 10},get linesPerLevel(){return 10},get moveTimeStep(){return 25},get padding(){return 8},get randomTiles(){return 6},get tileHeight(){return 30},get tileWidth(){return 30}},c=function(t,i){var o=document.createElement("canvas"),u,f=t+n.depth,e=i+n.depth,r;return o.setAttribute("width",f),o.setAttribute("height",e),r=o.getContext("2d"),r.fillStyle="",u=r.createLinearGradient(0,i,0,e),u.addColorStop(0,"rgba(0, 0, 0, 0.25)"),u.addColorStop(1,"rgba(0, 0, 0, 0.75)"),r.fillStyle=u,r.beginPath(),r.moveTo(0,i),r.lineTo(n.depth,e),r.lineTo(f,e),r.lineTo(t,i),r.closePath(),r.fill(),u=r.createLinearGradient(t,0,f,0),u.addColorStop(0,"rgba(0, 0, 0, 0.25)"),u.addColorStop(1,"rgba(0, 0, 0, 0.75)"),r.fillStyle=u,r.beginPath(),r.moveTo(t,0),r.lineTo(t,i),r.lineTo(f,e),r.lineTo(f,n.depth),r.closePath(),r.fill(),o.toDataURL()},o=function(n){n()},i={I:{name:"I",basePosition:[[0,0],[0,1],[0,2],[0,3]]},J:{name:"J",basePosition:[[0,0],[0,1],[0,2],[1,2]]},L:{name:"L",basePosition:[[0,0],[0,1],[0,2],[1,0]]},O:{name:"O",basePosition:[[0,0],[0,1],[1,0],[1,1]]},S:{name:"S",basePosition:[[1,0],[1,1],[0,1],[0,2]]},T:{name:"T",basePosition:[[0,0],[0,1],[0,2],[1,1]]},Z:{name:"Z",basePosition:[[0,0],[0,1],[1,1],[1,2]]}},r=function(){var n=Object.keys(i);return i[n[Math.floor(Math.random()*n.length)]]},s=function(n,t,i){var r;switch(n){case"I":switch(i){case 0:case 2:r=[[t[0][0]+2,t[0][1]+-2],[t[1][0]+1,t[1][1]+-1],[t[2][0]+0,t[2][1]+0],[t[3][0]+-1,t[3][1]+1],];break;case 1:case 3:r=[[t[0][0]+-2,t[0][1]+2],[t[1][0]+-1,t[1][1]+1],[t[2][0]+0,t[2][1]+0],[t[3][0]+1,t[3][1]+-1],]}break;case"J":switch(i){case 0:r=[[t[0][0]+-1,t[0][1]+-1],[t[1][0]+0,t[1][1]+0],[t[2][0]+1,t[2][1]+1],[t[3][0]+2,t[3][1]+0],];break;case 1:r=[[t[0][0]+-1,t[0][1]+1],[t[1][0]+0,t[1][1]+0],[t[2][0]+1,t[2][1]+-1],[t[3][0]+0,t[3][1]+-2],];break;case 2:r=[[t[0][0]+1,t[0][1]+1],[t[1][0]+0,t[1][1]+0],[t[2][0]+-1,t[2][1]+-1],[t[3][0]+-2,t[3][1]+-0],];break;case 3:r=[[t[0][0]+1,t[0][1]+-1],[t[1][0]+0,t[1][1]+0],[t[2][0]+-1,t[2][1]+1],[t[3][0]+0,t[3][1]+2],]}break;case"L":switch(i){case 0:r=[[t[0][0]+-1,t[0][1]+-1],[t[1][0]+0,t[1][1]+0],[t[2][0]+1,t[2][1]+1],[t[3][0]+0,t[3][1]+-2],];break;case 1:r=[[t[0][0]+-1,t[0][1]+1],[t[1][0]+0,t[1][1]+0],[t[2][0]+1,t[2][1]+-1],[t[3][0]+-2,t[3][1]+0],];break;case 2:r=[[t[0][0]+1,t[0][1]+1],[t[1][0]+0,t[1][1]+0],[t[2][0]+-1,t[2][1]+-1],[t[3][0]+0,t[3][1]+2],];break;case 3:r=[[t[0][0]+1,t[0][1]+-1],[t[1][0]+0,t[1][1]+0],[t[2][0]+-1,t[2][1]+1],[t[3][0]+2,t[3][1]+0],]}break;case"O":r=t;break;case"S":switch(i){case 0:case 2:r=[[t[0][0]+0,t[0][1]+-2],[t[1][0]+1,t[1][1]+-1],[t[2][0]+0,t[2][1]+0],[t[3][0]+1,t[3][1]+1],];break;case 1:case 3:r=[[t[0][0]+0,t[0][1]+2],[t[1][0]+-1,t[1][1]+1],[t[2][0]+0,t[2][1]+0],[t[3][0]+-1,t[3][1]+-1],]}break;case"T":switch(i){case 0:r=[[t[0][0]+-1,t[0][1]+-1],[t[1][0]+0,t[1][1]+0],[t[2][0]+1,t[2][1]+1],[t[3][0]+1,t[3][1]+-1],];break;case 1:r=[[t[0][0]+-1,t[0][1]+1],[t[1][0]+0,t[1][1]+0],[t[2][0]+1,t[2][1]+-1],[t[3][0]+-1,t[3][1]+-1],];break;case 2:r=[[t[0][0]+1,t[0][1]+1],[t[1][0]+0,t[1][1]+0],[t[2][0]+-1,t[2][1]+-1],[t[3][0]+-1,t[3][1]+1],];break;case 3:r=[[t[0][0]+1,t[0][1]+-1],[t[1][0]+0,t[1][1]+0],[t[2][0]+-1,t[2][1]+1],[t[3][0]+1,t[3][1]+1],]}break;case"Z":switch(i){case 0:case 2:r=[[t[0][0]+-1,t[0][1]+-1],[t[1][0]+0,t[1][1]+0],[t[2][0]+1,t[2][1]+-1],[t[3][0]+2,t[3][1]+0],];break;case 1:case 3:r=[[t[0][0]+1,t[0][1]+1],[t[1][0]+0,t[1][1]+0],[t[2][0]+-1,t[2][1]+1],[t[3][0]+-2,t[3][1]+0],]}}return r},e;Object.keys(i).forEach(function(n){i[n].rotate=function(t,i){return s(n,t,i)}});e=function(){var s,h=0,e,f,o=function(n){return(n||f).map(function(n){return n[1]})},v=function(n){return(n||f).map(function(n){return n[0]})},a=function(n){var t=f.filter(function(n){return n[0]>=0}).map(function(t){return n.apply(this,t)});t.filter(function(n){return!n}).length&&(e=!0)},c=r(),l;return s=c.name,f=c.basePosition,l=function(n,i){var r=o(n),f=Math.floor((i-u(r)-t(r)+1)/2)-1;return f&&(n=n.map(function(n){return[n[0],n[1]+f]})),n},f=l(f,n.boardWidth),{className:s,createPreview:function(){var r=document.createElement("canvas"),t,u;return r.setAttribute("width",n.tileWidth*4),r.setAttribute("height",n.tileHeight*4),t=r.getContext("2d"),t.strokeStyle="gray",u=l(i[s].basePosition,4),u.forEach(function(i){var r=[i[1]*n.tileWidth,i[0]*n.tileHeight,n.tileWidth,n.tileHeight];t.fillRect.apply(t,r);t.strokeRect.apply(t,r)}),r.toDataURL()},drop:function(){var i=this,n;e||(n=t(f.map(function(n){return i.findEmptyTiles.apply(i,n)})),n&&(f=f.map(function(t){return[t[0]+n,t[1]]})),a(this.findEmptyTiles))},get locked(){return e},isTileVisible:function(n){return f[n][0]>=0},moveDown:function(){a(this.findEmptyTiles);e||(f=f.map(function(n){return[n[0]+1,n[1]]}))},moveLeft:function(){if(!e){var n=this,i=t(o());i>0&&f.filter(function(t){return!n.isTileFree(t[0],t[1]-1)}).length===0&&(f=f.map(function(n){return[n[0],n[1]-1]}))}},moveRight:function(){if(!e){var t=this,i=u(o());i<n.boardWidth-1&&f.filter(function(n){return!t.isTileFree(n[0],n[1]+1)}).length===0&&(f=f.map(function(n){return[n[0],n[1]+1]}))}},rotate:function(){if(!e){var r=(h+1)%4,i=c.rotate(f,r),s=o(i),l=this;t(s)>=0&&u(s)<n.boardWidth&&i.filter(function(n){return n[0]>=0&&!l.isTileFree.apply(this,n)}).length===0&&(h=r,f=i)}},get rotation(){return h},get tiles(){return f}}};a=function(t,u,s){var nt,l,p,tt,d,k,it,y,rt={},v=u&&u.paused,a,ut=0,c,ft;Object.keys(i).forEach(function(n){var t=i[n];rt[t.name]=0});var et=function(n,t){return n+"°"+t},w=function(){if(g(),c&&c.locked){p=Date.now();c.tiles.forEach(function(n,t){if(c.isTileVisible(t)){var i=ot.apply(this,n);i.className=c.className;i.locked=!0}});var r=Object.keys(a).map(n=>a[n]).reduce(function(n,t){return(n[t.row]||(n[t.row]=function(){var n=[];return n.row=t.row,n}())).push(t),n},[]),i=r.filter(function(t){return t.filter(function(n){return n.className}).length==n.boardWidth}).map(function(n){return n.row});i.length&&(function(){var t=0,n;for(console.log(i.length+" filled"),i.sort(function(n,t){return t-n}),n=i[0];n>=0;n--){while(i.includes(n-t))console.log("line "+n+" is filled"),t++;console.log("moving row "+(n-t)+" to row "+n+" ("+t+" rows down)");r[n].forEach(function(i){var u=n-t>=0?r[n-t].filter(function(n){return n.column===i.column}).pop():{};i.className=u.className;i.locked=u.locked;i.baseTile&&(i.baseTile=!1,ut--)})}}(),Math.floor(k/n.linesPerLevel)!==Math.floor((k+i.length)/n.linesPerLevel)&&(tt++,d=Math.max(n.moveTimeStep,d-n.moveTimeStep)),k+=i.length,g());st();t.dispatchEvent(new Event("game.changed"));l&&t.dispatchEvent(new Event("game.lost"))}b(f,l?undefined:{start:nt})},ct=function(n,t){var r=Object.keys(a).map(function(n){return a[n]}).filter(function(i){return i.column==t&&!i.className&&i.row>n}).map(function(n){return n.row}),i;for(r.sort(function(n,t){return n-t}),i=0;i<r.length;i++)if(r[i]!==n+i+1)return i;return r.length},ot=function(n,t){return a[et(n,t)]},st=function(){var n=function(){var n=new e;return n.findEmptyTiles=ct,n.isTileFree=ht,n};y||(y=n());c=y;rt[c.className]++;it++;y=n();g();y.tiles.filter(function(n){return!ht.apply(this,n)}).length>0&&(l=Date.now(),g())},ht=function(n,t){return n<0||!ot(n,t).className},g=function(){Object.keys(a).forEach(function(n){var i=a[n],t=i.tile.classList;t.remove("I");t.remove("J");t.remove("L");t.remove("O");t.remove("S");t.remove("T");t.remove("Z");t.remove("locked");t.remove("base-tile");t.add(i.className);i.locked&&t.add("locked");i.baseTile&&t.add("base-tile");c&&c.tiles.forEach(function(n){n[0]===i.row&&n[1]===i.column&&t.add(c.className)})})};return o(function(){h(t);t.style.padding=n.padding+"px";t.style.width=n.tileWidth*n.boardWidth+2*n.padding+"px";t.style.height=n.tileHeight*n.boardHeight+2*n.padding+"px";var i=document.createElement("div");i.classList.add("level-container");a={},function(){for(var u,t,r=0;r<n.boardHeight;r++)for(u=0;u<n.boardWidth;u++)t=document.createElement("div"),t.classList.add("tile"),t.classList.add("fade"),t.style.gridColumn=u+1,t.style.gridRow=r+1,t.style.width=n.tileWidth+"px",t.style.height=n.tileHeight+"px",i.appendChild(t),a[et(r,u)]={row:r,column:u,tile:t}}();u&&u.lines&&function(){for(var t,e,f,i=0;i<u.lines;i++)for(t=Object.keys(a).map(function(n){return a[n]}).filter(function(t){return t.row===n.boardHeight-i-1}),e=0;e<n.randomTiles;e++)f=Math.floor(Math.random()*t.length),t[f].className=r().name,t[f].baseTile=!0,t.splice(f,1),ut++}();t.appendChild(i);s&&(tt=1,it=k=0,nt=Date.now(),p=undefined,d=n.baseMoveTime,st(),s(),ft=window.setInterval(function(){if(!l&&!v){var n=Date.now();(!p||n-p>=d)&&(p&&c.moveDown(),p=n,w())}},50))}),{get baseLines(){return ut/n.randomTiles},board:{get width(){return n.boardWidth*n.tileWidth},get height(){return n.boardHeight*n.tileHeight}},get constants(){return n},dropPiece:function(){v||l||!c||(c.drop(),w())},get end(){return l},getNextPiecePreview:function(){return y&&y.createPreview()},get level(){return tt},get lines(){return k},movePieceDown:function(){v||l||!c||(c.moveDown(),w())},movePieceLeft:function(){v||l||!c||(c.moveLeft(),w())},movePieceRight:function(){v||l||!c||(c.moveRight(),w())},pause:function(){v=!v},get paused(){return v},get pieces(){return it},get pieceStats(){return rt},resume:function(){v=!1},rotatePiece:function(){v||l||!c||(c.rotate(),w())},get start(){return nt},stop:function(){l=Date.now();window.clearInterval(ft);ft=undefined}}}})(),function(){var t=document.querySelector(".board"),k=document.getElementById("menu"),u=document.getElementById("message"),v=document.querySelector(".scaler"),tt=document.querySelector(".status");(function(){typeof ShadowRoot=="undefined"&&(u.classList.add("compatible"),k.classList.add("compatible"));c("animate")&&document.querySelector("body").classList.add("animate")})();var n,d,nt=function(){r(u)?(e(),y()):n?w(document.getElementById("askNewMessage").value):y()},b=function(){g&&g();Array.from(document.getElementsByClassName("level")).forEach(function(t){t.innerText=n&&n.level});Array.from(document.getElementsByClassName("lines")).forEach(function(t){t.innerText=n&&n.lines});Array.from(document.getElementsByClassName("pieces")).forEach(function(t){t.innerText=n&&n.pieces});Array.from(document.getElementsByClassName("base-lines")).forEach(function(t){t.innerText=n&&n.baseLines});Array.from(document.getElementsByClassName("next-piece")).forEach(function(t){var i=n&&n.getNextPiecePreview();typeof i=="string"?t.setAttribute("src",i):(h(t),t.appendChild(i))});Array.from(document.getElementsByClassName("piece-stats")).forEach(function(t){var i;n&&(i=n.pieceStats,i=Object.keys(i).map(function(n){return[n,i[n]]}),i.sort(function(n,t){return t[1]-n[1]}),i=i.map(function(n){return n[0]+": "+n[1].toLocaleString()}).join("\n"));t.innerText=i})},e=function(){i(u);i(k);i(document.getElementById("messageBackdrop"))},y=function(i,r){n&&(n.stop(),n=undefined,t.removeEventListener("game.changed",b));n=new a(t,{lines:7,paused:r},function(){t.addEventListener("game.changed",b);setTimeout(function(){d();b()})},i)},it=function(){n.nextHint()},g=function(){var t=0,i,r="";n&&n.start&&(t=(n.end||Date.now())-n.start);t=Math.floor(t/1e3);t>=3600&&(r=Math.floor(t/3600)+":",t%=3600);i=Math.floor(t/60);t%=60;r.length&&i<10&&(i="0"+i);r+=i+":";t<10&&(t="0"+t);Array.from(document.getElementsByClassName("time")).forEach(function(n){n.innerText=r+t})},w=function(t){n&&n.pause();document.getElementById("messageText").innerText=t;l(document.getElementById("messageBackdrop"));l(u)};(function(){t.addEventListener("game.changed",b);t.addEventListener("game.won",function(){w(document.getElementById("wonMessage").value)});t.addEventListener("game.lost",function(){w(document.getElementById("lostMessage").value)});t.addEventListener("game.wrong",function(){w(document.getElementById("wrongGameMessage").value)});o(tt,"newGame",nt);document.getElementById("messageBackdrop").addEventListener("click",function(){e()});s(u,"button",e);o(u,"newGame",function(){y()});s(k,"button",e)})();document.addEventListener("keydown",function(t){switch(t.which){case 13:r(u)?(e(),y()):n&&n.dropPiece();break;case 19:case 80:n&&n.pause();break;case 27:r(u)?e():n&&n.pause();break;case 32:n&&n.dropPiece();break;case 37:case 65:n&&n.movePieceLeft();break;case 38:case 75:case 87:n&&n.rotatePiece();break;case 39:case 68:n&&n.movePieceRight();break;case 40:case 83:n&&n.movePieceDown();break;case 71:w((new Date).toLocaleString());break;case 113:nt();break;default:console.info(t.which)}});(d=function(){if(n){var r=(window.innerWidth-2*n.constants.padding)/n.board.width,u=(window.innerHeight-2*n.constants.padding)/n.board.height,i=1;t.clientHeight&&((r<1||u<1)&&(i=Math.min(r,u)),v.style["-ms-transform"]=v.style["-moz-transform"]=v.style["-o-transform"]=v.style["-webkit-transform"]=v.style.transform=i<1?"scale("+i+")":"")}})();window.addEventListener("resize",d);window.setInterval(g,100);document.addEventListener("DOMContentLoaded",function(){y(p(f),!0)})}()})()