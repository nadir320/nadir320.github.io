"use strict";(function(){var v="tetris-game-state",h="session",p="tetris-style",f=Array.prototype.slice.call(window.document.getElementsByTagName("script")).pop();(function(){Array.prototype.findIndex||(Array.prototype.findIndex=function(n){for(var i=this,t=0,r=this.length;t<r;t++)if(n.call(i,this[t],t))return t;return-1});Array.from||(Array.from=function(n){for(var i=[],t=0,r=n.length;t<r;t++)i.push(n[t]);return i});var n=f.getAttribute("storage");n&&n.length&&(h=n);h+="Storage"})();var y=function(n,t){Array.from(typeof n.length!="undefined"?n:[n]).forEach(function(n){n.addEventListener("click",t)})},e=function(n,t,i){y(n.querySelectorAll("."+t),i)},w=function(n,t,i){y(n.getElementsByTagName(t),i)},l=function(n){Array.from(n.childNodes).forEach(function(n){n.parentElement.removeChild(n)})},tt=function(n){var t={};return Object.keys(n).forEach(function(i){t[i]=n[i]}),t},o=function(n){n.classList.add("hidden")},t=function(n){return!n.classList.contains("hidden")},s=function(n){for(var t=undefined,i,r=0,u=n.length;r<u;r++)i=n[r],t=t===undefined?i:Math.max(t,i);return t},i=function(n){for(var t=undefined,i,r=0,u=n.length;r<u;r++)i=n[r],t=t===undefined?i:Math.min(t,i);return t},n=function(n){return Object.keys(c()).findIndex(function(t){return t.toLowerCase()===n.toLowerCase()})>=0},c=function(n){var t=(n=n||window.location.href).indexOf("?"),i={};return t>=0&&(n=n.substr(t+1),t=n.indexOf("#"),t>=0&&(n=n.substr(0,t)),n.split("&").forEach(function(n){var t=n.indexOf("="),r=n.substr(0,t),u=n.substr(t+1);i[r||u]=r?window.decodeURIComponent(u):undefined})),i},b=function(n){var t=k(n);if(t&&t.length)try{return window.JSON.parse(t)}catch(i){}},k=function(n){try{var t=window[h];if(t&&t.getItem)return t.getItem(n)}catch(i){}},a=function(n,t){var i;t&&(i=document.getElementById(t))?i.innerText=n:(i=document.createElement("style"),i.setAttribute("type","text/css"),t&&i.setAttribute("id",t),i.innerText=n,document.querySelector("head").appendChild(i))},r=function(n){n.classList.remove("hidden")},d=function(n,t){typeof t!="undefined"&&(t=window.JSON.stringify(t));g(n,t)},g=function(n,t){try{var i=window[h];i&&(typeof t!="undefined"?i.setItem&&i.setItem(n,t):i.removeItem&&i.removeItem(n))}catch(r){}},it=n("debug"),nt=n("cw"),u;(function(){var n={get boardHeight(){return 20},get boardWidth(){return 10},levelMoveTime:function(n,t){var i=t?25:35;return Math.max(i,500-(n-1)*i)},get levels(){return 25},get linesPerLevel(){return 10},get padding(){return 8},get randomTiles(){return 4},get tileHeight(){return 30},get tileWidth(){return 30}},t={I:{name:"I",basePosition:[[0,0],[0,1],[0,2],[0,3]],baseRotation:1},J:{name:"J",basePosition:[[0,0],[0,1],[0,2],[1,2]],baseRotation:3},L:{name:"L",basePosition:[[0,0],[0,1],[0,2],[1,0]],baseRotation:1},O:{name:"O",basePosition:[[0,0],[0,1],[1,0],[1,1]],baseRotation:0},S:{name:"S",basePosition:[[1,0],[1,1],[0,1],[0,2]],baseRotation:1},T:{name:"T",basePosition:[[0,0],[0,1],[0,2],[1,1]],baseRotation:0},Z:{name:"Z",basePosition:[[0,0],[0,1],[1,1],[1,2]],baseRotation:1}},f=function(){var n=Object.keys(t);return t[n[Math.floor(Math.random()*n.length)]]},e=function(n,t,i){var r;switch(n){case"I":switch(i){case 0:case 2:r=[[t[0][0]+2,t[0][1]+-2],[t[1][0]+1,t[1][1]+-1],[t[2][0]+0,t[2][1]+0],[t[3][0]+-1,t[3][1]+1],];break;case 1:case 3:r=[[t[0][0]+-2,t[0][1]+2],[t[1][0]+-1,t[1][1]+1],[t[2][0]+0,t[2][1]+0],[t[3][0]+1,t[3][1]+-1],]}break;case"J":switch(i){case 0:r=[[t[0][0]+-1,t[0][1]+-1],[t[1][0]+0,t[1][1]+0],[t[2][0]+1,t[2][1]+1],[t[3][0]+2,t[3][1]+0],];break;case 1:r=[[t[0][0]+-1,t[0][1]+1],[t[1][0]+0,t[1][1]+0],[t[2][0]+1,t[2][1]+-1],[t[3][0]+0,t[3][1]+-2],];break;case 2:r=[[t[0][0]+1,t[0][1]+1],[t[1][0]+0,t[1][1]+0],[t[2][0]+-1,t[2][1]+-1],[t[3][0]+-2,t[3][1]+-0],];break;case 3:r=[[t[0][0]+1,t[0][1]+-1],[t[1][0]+0,t[1][1]+0],[t[2][0]+-1,t[2][1]+1],[t[3][0]+0,t[3][1]+2],]}break;case"L":switch(i){case 0:r=[[t[0][0]+-1,t[0][1]+-1],[t[1][0]+0,t[1][1]+0],[t[2][0]+1,t[2][1]+1],[t[3][0]+0,t[3][1]+-2],];break;case 1:r=[[t[0][0]+-1,t[0][1]+1],[t[1][0]+0,t[1][1]+0],[t[2][0]+1,t[2][1]+-1],[t[3][0]+-2,t[3][1]+0],];break;case 2:r=[[t[0][0]+1,t[0][1]+1],[t[1][0]+0,t[1][1]+0],[t[2][0]+-1,t[2][1]+-1],[t[3][0]+0,t[3][1]+2],];break;case 3:r=[[t[0][0]+1,t[0][1]+-1],[t[1][0]+0,t[1][1]+0],[t[2][0]+-1,t[2][1]+1],[t[3][0]+2,t[3][1]+0],]}break;case"O":r=t;break;case"S":switch(i){case 0:case 2:r=[[t[0][0]+0,t[0][1]+-2],[t[1][0]+1,t[1][1]+-1],[t[2][0]+0,t[2][1]+0],[t[3][0]+1,t[3][1]+1],];break;case 1:case 3:r=[[t[0][0]+0,t[0][1]+2],[t[1][0]+-1,t[1][1]+1],[t[2][0]+0,t[2][1]+0],[t[3][0]+-1,t[3][1]+-1],]}break;case"T":switch(i){case 0:r=[[t[0][0]+-1,t[0][1]+-1],[t[1][0]+0,t[1][1]+0],[t[2][0]+1,t[2][1]+1],[t[3][0]+1,t[3][1]+-1],];break;case 1:r=[[t[0][0]+-1,t[0][1]+1],[t[1][0]+0,t[1][1]+0],[t[2][0]+1,t[2][1]+-1],[t[3][0]+-1,t[3][1]+-1],];break;case 2:r=[[t[0][0]+1,t[0][1]+1],[t[1][0]+0,t[1][1]+0],[t[2][0]+-1,t[2][1]+-1],[t[3][0]+-1,t[3][1]+1],];break;case 3:r=[[t[0][0]+1,t[0][1]+-1],[t[1][0]+0,t[1][1]+0],[t[2][0]+-1,t[2][1]+1],[t[3][0]+1,t[3][1]+1],]}break;case"Z":switch(i){case 0:case 2:r=[[t[0][0]+-1,t[0][1]+-1],[t[1][0]+0,t[1][1]+0],[t[2][0]+1,t[2][1]+-1],[t[3][0]+2,t[3][1]+0],];break;case 1:case 3:r=[[t[0][0]+1,t[0][1]+1],[t[1][0]+0,t[1][1]+0],[t[2][0]+-1,t[2][1]+1],[t[3][0]+-2,t[3][1]+0],]}}return r},r;Object.keys(t).forEach(function(n){t[n].rotate=function(t,i){return e(n,t,i)}});r=function(r){var a,h=0,c,u,l=function(n){return(n||u).map(function(n){return n[1]})},p=function(n){return(n||u).map(function(n){return n[0]})},y=function(n){var t=u.filter(function(n){return n[0]>=0}).map(function(t){return n.apply(this,t)});t.filter(function(n){return!n}).length&&(c=!0)},v=function(n,t,r){var u,f,o;if(n=n.slice(),r)for(u=0;u<r;u++)n=e(a,n,u+1);return f=l(n),o=Math.floor((t-s(f)-i(f)+1)/2)-1,o&&(n=n.map(function(n){return[n[0],n[1]+o]})),n},o;return r?r.tiles?(o=t[r.className],h=r.rotation,c=r.locked):(o=t[r],h=o.baseRotation):(o=f(),h=o.baseRotation),a=o.name,u=r&&r.tiles?r.tiles:v(o.basePosition,n.boardWidth,o.baseRotation),{className:a,createPreview:function(t){for(var u,r,e=v(o.basePosition,4,t?h:0),c=l(e),y=p(e),w=i(c),b=i(y),d=s(c)-w+1,g=s(y)-b+1,k=document.createElement("div"),f=0;f<g;f++)for(u=0;u<d;u++)e.filter(function(n){return n[0]===f+b&&n[1]===u+w}).length&&(r=document.createElement("div"),r.classList.add(a),r.style.gridColumn=u+1,r.style.gridRow=f+1,r.style.width=n.tileWidth+"px",r.style.height=n.tileHeight+"px",k.appendChild(r));return k},createPreviewImage:function(t,i){var u=document.createElement("canvas"),r,f;return u.setAttribute("width",n.tileWidth*4),u.setAttribute("height",n.tileHeight*4),r=u.getContext("2d"),r.fillStyle=t,r.strokeStyle=t,f=v(o.basePosition,4,i?h:0),f.forEach(function(t){var i=[t[1]*n.tileWidth,t[0]*n.tileHeight,n.tileWidth,n.tileHeight];r.fillRect.apply(r,i);r.strokeRect.apply(r,i)}),u.toDataURL()},drop:function(){var t=this,n;c||(n=t.getShadow(),n&&(u=n),y(this.findEmptyTiles))},getShadow:function(){var n=this,t=i(u.map(function(t){return n.findEmptyTiles.apply(n,t)}));if(t)return u.map(function(n){return[n[0]+t,n[1]]})},get locked(){return c},isTileVisible:function(n){return u[n][0]>=0},moveDown:function(){y(this.findEmptyTiles);c||(u=u.map(function(n){return[n[0]+1,n[1]]}))},moveLeft:function(){if(!c){var n=this,t=i(l());t>0&&u.filter(function(t){return!n.isTileEmpty(t[0],t[1]-1)}).length===0&&(u=u.map(function(n){return[n[0],n[1]-1]}))}},moveRight:function(){if(!c){var t=this,i=s(l());i<n.boardWidth-1&&u.filter(function(n){return!t.isTileEmpty(n[0],n[1]+1)}).length===0&&(u=u.map(function(n){return[n[0],n[1]+1]}))}},rotate:function(t){var f;if(!c)if(nt||t){var e=(h+1)%4,r=o.rotate(u,e),a=l(r),v=this;i(a)>=0&&s(a)<n.boardWidth&&r.filter(function(n){return n[0]>=0&&!v.isTileEmpty.apply(this,n)}).length===0&&(h=e,u=r)}else for(f=0;f<3;f++)this.rotate(!0)},get rotation(){return h},get tiles(){return u.slice()}}},function(){for(var r=[".level-container { background-color: whitesmoke; }"],t,i=1;i<=n.levels;i++)t=Math.min(Math.max(Math.floor(255-(i-1)/n.levels*255),0),255),r.push('.level-container[level="'+i+'"] { background-color: rgba('+t+", "+t+", "+t+", 1); background: radial-gradient(circle, rgba("+t+", "+t+", "+t+", 1) 0%, rgba(255, 255, 255, 1) 100%); }");a(r.join(" "),p)}();u=function(i,u,e,o){var it,k,ct=0,c,rt,pt,lt,p,at,b,vt=[],ut,a,g={},y=u&&u.paused,h,ft=0,et,ot,nt=0,yt=0,s,wt;Object.keys(t).forEach(function(n){var i=t[n];g[i.name]={currentStreak:0,currentNegativeStreak:0,maximumStreak:0,maximumNegativeStreak:0,total:0}});var st=function(n,t){return n+"°"+t},dt=function(){if(ft&&(ot||nt||(ot=!0),!et)){var t=Object.keys(h).map(function(n){return h[n]}).filter(function(n){return n.className}),i=t.filter(function(n){return n.baseTile});i.filter(function(t){for(var r,u,f,i=t.row+1;i<n.boardHeight;i++)if(w(i,t.column))return!0;for(u=w(t.row-1,t.column),f=!1,i=t.row-2;i>=0;i--)if(r=w(i,t.column),r!==u){if(f)return!0;u=r}return!1}).length===0&&t.filter(function(t){for(var i=t.row+1;i<n.boardHeight;i++)if(w(i,t.column))return!0;return!1}).length===0&&(et=!0)}},tt=function(){if(ht(),s&&s.locked){pt=rt=Date.now();s.tiles.forEach(function(n,t){if(s.isTileVisible(t)){var i=gt.apply(this,n);i.className=s.className;i.locked=!0}});var r=Object.keys(h).map(function(n){return h[n]}).reduce(function(n,t){return(n[t.row]||(n[t.row]=function(){var n=[];return n.row=t.row,n}())).push(t),n},[]),t=r.filter(function(t){return t.filter(function(n){return n.className}).length==n.boardWidth}).map(function(n){return n.row});t.length&&(function(){var i,n;for(vt.push(t.length),t.sort(function(n,t){return t-n}),i=0,n=t[0];n>=0;n--){while(t.includes(n-i))i++;r[n].forEach(function(t){var u=n-i>=0?r[n-i].filter(function(n){return n.column===t.column}).pop():{};t.className=u.className;t.locked=u.locked;t.baseTile&&(t.baseTile=!1,nt--)})}dt()}(),Math.floor(b/n.linesPerLevel)!==Math.floor((b+t.length)/n.linesPerLevel)&&(p++,at=n.levelMoveTime(p,u.slow)),b+=t.length,ht());yt=Object.keys(h).map(function(n){return h[n].className}).filter(function(n){return n}).length;kt();i.dispatchEvent(new Event("game.changed"));c&&i.dispatchEvent(new Event("game.lost"))}d(v,c?undefined:{allTiles:Object.keys(h).reduce(function(n,t){var i=h[t];return n[t]={baseTile:i.baseTile,className:i.className,column:i.column,locked:i.locked,row:i.row},n},{}),baseCleared:et,baseRemoved:ot,baseLines:u&&u.lines||0,baseTiles:ft,elapsed:ct,level:p,lineHistory:vt,lines:b,nextPiece:a.className,piece:s,pieceStats:g,pieces:ut,remainingBaseTiles:nt,remainingTiles:yt,start:k})},bt=function(n,t){var r=Object.keys(h).map(function(n){return h[n]}).filter(function(i){return i.column==t&&!i.className&&i.row>n}).map(function(n){return n.row}),i;if(n<0)for(i=-1;i>n;i--)r.splice(0,0,i);for(r.sort(function(n,t){return n-t}),i=0;i<r.length;i++)if(r[i]!==n+i+1)return i;return r.length},gt=function(n,t){return h[st(n,t)]},kt=function(){var n=function(){var n;do n=new r;while(it.length&&!it.includes(n.className));return n.findEmptyTiles=bt,n.isTileEmpty=w,n},t;a||(a=n());t=s&&s.className===a.className;s=a;Object.keys(g).forEach(function(n){var i=g[n];n==s.className?(i.total++,t?i.currentStreak++:i.currentStreak=1,i.currentNegativeStreak=0):(i.currentStreak=0,i.currentNegativeStreak++);i.maximumStreak=Math.max(i.maximumStreak,i.currentStreak);i.maximumNegativeStreak=Math.max(i.maximumNegativeStreak,i.currentNegativeStreak)});ut++;a=n();ht();a.tiles.filter(function(n){return!w.apply(this,n)}).length>0&&(c=Date.now(),ht())},w=function(n,t){return n<0||!gt(n,t).className},ht=function(){var n;Array.from(document.getElementsByClassName("level-container")).forEach(function(n){p>1?n.setAttribute("level",p):n.removeAttribute("level")});Object.keys(h).forEach(function(n){var i=h[n],t=i.tile.classList;t.remove("I");t.remove("J");t.remove("L");t.remove("O");t.remove("S");t.remove("T");t.remove("Z");t.remove("locked");t.remove("base-tile");t.remove("shadow");i.className&&t.add(i.className);i.locked&&t.add("locked");i.baseTile&&t.add("base-tile")});s&&(s.tiles.forEach(function(n,t){s.isTileVisible(t)&&h[st(n[0],n[1])].tile.classList.add(s.className)}),u&&u.shadow&&(n=s.getShadow())&&n.filter(function(n){return s.tiles.filter(function(t){return t[0]===n[0]&&t[1]===n[1]}).length===0}).forEach(function(n){h[st(n[0],n[1])].tile.classList.add("shadow")}))};return function(){l(i);i.style.padding=n.padding+"px";i.style.width=n.tileWidth*n.boardWidth+2*n.padding+"px";i.style.height=n.tileHeight*n.boardHeight+2*n.padding+"px";var v=document.createElement("div");v.classList.add("level-container");h={},function(){for(var r,t,i=0;i<n.boardHeight;i++)for(r=0;r<n.boardWidth;r++)t=document.createElement("div"),t.classList.add("tile"),u.fade&&t.classList.add("fade"),t.style.gridColumn=r+1,t.style.gridRow=i+1,t.style.width=n.tileWidth+"px",t.style.height=n.tileHeight+"px",v.appendChild(t),h[st(i,r)]={row:i,column:r,tile:t}}();o&&o.start?(Object.keys(o.allTiles).map(function(n){return o.allTiles[n]}).forEach(function(n){var t=h[st(n.row,n.column)];t.baseTile=!!n.baseTile;n.className&&(t.className=n.className);t.locked=!!n.locked}),a=new r(o.nextPiece),a.findEmptyTiles=bt,a.isTileEmpty=w,s=new r(o.piece),s.findEmptyTiles=bt,s.isTileEmpty=w):u&&u.lines>0&&function(){for(var i,o,r,s,c=Math.min(u.lines,n.boardHeight-4),e=0;e<c;e++)for(i=Object.keys(h).map(function(n){return h[n]}).filter(function(t){return t.row===n.boardHeight-e-1}),o=0;o<n.randomTiles;o++){r=Math.floor(Math.random()*i.length);do s=f().name;while(s===t.Z.name);i[r].className=s;i[r].baseTile=!0;i.splice(r,1);ft++;nt++}}();i.appendChild(v);o&&o.start?(it=o.activePieces||[],et=o.baseCleared,ot=o.baseRemoved,ft=o.baseTiles,ct=o.elapsed,p=o.level,vt=o.lineHistory,b=o.lines,g=o.pieceStats,ut=o.pieces,nt=o.remainingBaseTiles,yt=o.remainingTiles,k=o.start):(it=u.activePieces||[],ut=b=0,p=1);at=n.levelMoveTime(p,u.slow);ht();y||(k=Date.now(),kt());e&&e();wt=window.setInterval(function(){if(!c&&!y){k||(k=Date.now(),kt(),dt(),i.dispatchEvent(new Event("game.changed")));var n=Date.now();lt&&(ct+=n-lt);(!rt||n-rt>=at)&&(rt&&s.moveDown(),rt=n,tt());lt=n}},50)}(),{get activePieces(){return it},get baseCleared(){return et},get baseLines(){return ft/n.randomTiles},get baseRemoved(){return ot},board:{get width(){return n.boardWidth*n.tileWidth},get height(){return n.boardHeight*n.tileHeight}},get constants(){return n},dropPiece:function(){y||c||!s||(!pt||Date.now()-pt>=at/2)&&(s.drop(),tt())},get elapsed(){return ct},get end(){return c},getNextPiecePreview:function(n){if(a)return a.createPreview(n)},get level(){return p},get lineHistory(){return vt},get lines(){return b},movePieceDown:function(){y||c||!s||(s.moveDown(),tt())},movePieceLeft:function(){y||c||!s||(s.moveLeft(),tt())},movePieceRight:function(){y||c||!s||(s.moveRight(),tt())},pause:function(){y||c||(y=!0,i.dispatchEvent(new Event("game.paused")))},get paused(){return y},get pieces(){return ut},get pieceStats(){return g},get remainingBaseLines(){return nt/n.randomTiles},get remainingTiles(){return yt},resume:function(){y&&!c&&(lt=Date.now(),y=!1,i.dispatchEvent(new Event("game.resumed")))},rotatePiece:function(){y||c||!s||(s.rotate(),tt())},get start(){return k},stop:function(){c=Date.now();window.clearInterval(wt);wt=undefined}}};u.createPreviews=function(){return Object.keys(t).map(function(n){var i=t[n];return{name:i.name,preview:new r(i.name).createPreview()}})}})(),function(){var wt="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=",bt=decodeURIComponent("%E3%85%A4"),y,kt=!n("no-fade")&&!parseInt(f.getAttribute("no-fade")),ct,et=n("boss")||!!parseInt(f.getAttribute("boss")),lt,dt=!!n("touch")||!!parseInt(f.getAttribute("touch")),s=document.querySelector(".board"),h=document.getElementById("message"),k=document.querySelector(".scaler"),ot=document.querySelector(".status"),nt=document.getElementById("stat-message");(function(){typeof ShadowRoot=="undefined"&&h.classList.add("compatible");n("animate")&&document.querySelector("body").classList.add("animate")})();var i,st,tt=function(n){Array.from(n.getElementsByTagName("div")).forEach(function(n){n.parentElement&&n.classList.add("tile")})},at=function(){t(h)?(d(),g()):i?ft(document.getElementById("askNewMessage").value):g()},it=function(n){if(Array.from(document.getElementsByClassName("boss")).forEach(function(t){(n?r:o)(t)}),y!==n){var t=document.querySelector("[rel='shortcut icon']");(y=n)?(i&&i.pause(),lt=document.title,document.title=bt,t&&(ct=t.getAttribute("href"),t.setAttribute("href",wt))):(document.title=lt,t&&t.setAttribute("href",ct))}},rt=function(){var n,t;ht&&ht();n=document.querySelector(".status");Array.from(n.getElementsByClassName("level")).forEach(function(n){n.innerText=i?i.level:undefined});Array.from(n.getElementsByClassName("lines")).forEach(function(n){n.innerText=(i?i.lines:0).toLocaleString()});Array.from(n.getElementsByClassName("line-details")).forEach(function(n){var t="";i&&i.lines&&(t=i.lineHistory.reduce(function(n,t){return n[t]=(n[t]||0)+1,n},[]).map(function(n,t){return{index:t,value:n}}),t.sort(function(n,t){return t.index-n.index}),t=t.filter(function(n){return n.value}).map(function(n){return n.index+": "+n.value.toLocaleString()}).join(" - "));n.innerText=t});Array.from(n.getElementsByClassName("pieces")).forEach(function(n){n.innerText=i?i.pieces:undefined});Array.from(n.getElementsByClassName("base-lines-row")).forEach(function(n){n.classList[i&&i.baseLines?"remove":"add"]("removed")});i&&i.baseLines&&Array.from(document.getElementsByClassName("base-lines")).forEach(function(n){n.innerText=i?i.remainingBaseLines.toLocaleString()+"/"+i.baseLines.toLocaleString()+" ("+i.remainingTiles.toLocaleString()+")":undefined;n.classList[i&&i.baseCleared?"add":"remove"]("base-cleared");n.classList[i&&i.baseRemoved?"add":"remove"]("base-removed")});Array.from(n.getElementsByClassName("next-piece-row")).forEach(function(n){n.classList[i&&i.start?"remove":"add"]("removed")});Array.from(n.getElementsByClassName("next-piece")).forEach(function(n){var t=i?i.getNextPiecePreview(!0):undefined;typeof t=="string"?n.setAttribute("src",t):(l(n),t&&(tt(t),n.appendChild(t)))});Array.from(n.getElementsByClassName("piece-stats-row")).forEach(function(n){n.classList[i&&i.start?"remove":"add"]("removed")});i&&(t=i.pieceStats,Array.from(n.getElementsByClassName("piece-stats")).forEach(function(n){Array.from(n.getElementsByClassName("stat-table")).forEach(function(n){var u=Array.from(n.getElementsByClassName("stat-row")),r={types:[],value:0};u.forEach(function(n){n.classList.remove("longest-negative-streak");Array.from(n.getElementsByClassName("stat-value")).forEach(function(i){var u=t[n.dataset.type];i.innerText=u.total.toLocaleString();r.value<=u.maximumNegativeStreak&&(r.value===u.maximumNegativeStreak?r.types.push(n.dataset.type):(r.types=[n.dataset.type],r.value=u.maximumNegativeStreak))})});r.types.forEach(function(t){n.querySelector(".stat-row[data-type="+t+"]").classList.add("longest-negative-streak")});u.sort(function(n,i){return t[i.dataset.type].total-t[n.dataset.type].total});u.forEach(function(t){n.appendChild(t);t.classList[i.activePieces.length&&i.activePieces.includes(t.dataset.type)?"remove":"add"]("removed")})})}))},vt=function(){Array.from(document.getElementsByClassName("pause")).forEach(function(n){r(n)})},yt=function(){Array.from(document.getElementsByClassName("pause")).forEach(function(n){o(n)})},d=function(){o(h);o(nt);o(document.getElementById("messageBackdrop"));s.focus()},g=function(t,r){i&&(i.stop(),i=undefined,s.removeEventListener("game.changed",rt));var f=[],e=0;t||(e=parseInt(Array.from(document.querySelectorAll("[name=initial-lines]")).filter(function(n){return n.checked}).pop().value),f=Array.from(document.querySelectorAll(".message .pieces input")).filter(function(n){return n.checked}).map(function(n){return n.dataset.piece}));i=new u(s,{fade:kt,lines:e||0,activePieces:f,paused:r,shadow:!n("no-shadow"),slow:!!n("slow")},function(){s.addEventListener("game.changed",rt);r?vt():yt();setTimeout(function(){st();rt()})},t)},ut=function(){i&&(i.paused?y||i.resume():i.pause())},ht=function(){var n=0,t,r="";i&&i.start&&(n=i.elapsed);n=Math.floor(n/1e3);n>=3600&&(r=Math.floor(n/3600)+":",n%=3600);t=Math.floor(n/60);n%=60;r.length&&t<10&&(t="0"+t);r+=t+":";n<10&&(n="0"+n);Array.from(document.getElementsByClassName("time")).forEach(function(t){t.innerText=r+n})},ft=function(n){y||(i&&i.pause(),document.getElementById("messageText").innerText=n,r(document.getElementById("messageBackdrop")),r(h),window.setTimeout(function(){try{document.querySelector("[name=initial-lines]:checked").focus()}catch(n){}}))},pt=function(n){var t;if(i){i.pause();var f=i.pieceStats,o=u.createPreviews(),e=nt.querySelector("table tbody");e.textContent="";t=Object.keys(f);i.activePieces.length&&(t=t.filter(function(n){return i.activePieces.includes(n)}));t.forEach(function(n){var r=document.createElement("tr"),u=function(n){var t=document.createElement("td");n instanceof HTMLElement?t.appendChild(n):t.textContent=n.toLocaleString();r.appendChild(t)},i=o.filter(function(t){return t.name==n}).pop(),t=f[n];tt(i.preview);i.preview.classList.add("preview");u(i.preview);[t.total,t.currentStreak,t.maximumStreak,t.currentNegativeStreak,t.maximumNegativeStreak].forEach(u);e.appendChild(r)});r(document.getElementById("messageBackdrop"));r(nt)}n&&n.preventDefault&&n.preventDefault()},p=function(n){switch(n.which){case 13:t(h)?(d(),g()):i&&(i.paused?y||i.resume():i.dropPiece());break;case 19:case 80:t(h)||ut();break;case 27:t(h)||t(nt)?d():et?it(!0):ut();break;case 32:!t(h)&&i&&(i.paused?y||i.resume():i.dropPiece());break;case 37:case 65:i&&i.movePieceLeft();break;case 38:case 75:case 87:i&&i.rotatePiece();break;case 39:case 68:i&&i.movePieceRight();break;case 40:case 83:i&&i.movePieceDown();break;case 66:it(!y);break;case 71:ft((new Date).toLocaleString());break;case 113:at();break;case 118:pt()}};(function(){s.addEventListener("game.changed",rt);s.addEventListener("game.won",function(){ft(document.getElementById("wonMessage").value)});s.addEventListener("game.lost",function(){ft(document.getElementById("lostMessage").value)});s.addEventListener("game.paused",vt);s.addEventListener("game.resumed",yt);e(ot,"stats",pt);e(ot,"newGame",at);e(ot,"pauseGame",ut);document.getElementById("messageBackdrop").addEventListener("click",function(){d()});w(h,"button",d);e(h,"newGame",function(){g()});e(document,"pause",function(){y||ut()});dt&&function(){var i=document.createElement("div"),n=[2,5,3,1],r=n.reduce(function(n,t){return n+t},0),u,t;for(i.classList.add("touch-container"),u=function(n){var t=document.createElement("div");t.classList.add("touch");t.classList.add(n);i.appendChild(t)},t=0;t<5;t++)u("touch-"+(t+1));a([".touch-container { grid-template-rows: "+n.map(function(n){return n+"fr"}).join(" ")+" }",".touch-1 { grid-area: 1 / 1 / span 1 / span 2}",".touch-2 { grid-area: 2 / 1 / span 1 / span 1}",".touch-3 { grid-area: 2 / 2 / span 1 / span 1}",".touch-4 { grid-area: 3 / 1 / span 1 / span 2}",".touch-5 { grid-area: 4 / 1 / span 1 / span 2}"].join(" "));document.body.appendChild(i);document.addEventListener("touchstart",function(t){var u=document.body.clientWidth,i=document.body.clientHeight;Array.from(t.touches).forEach(function(t){t.clientY<=i*n[0]/r?p({which:38}):t.clientY>=i*(n[0]+n[1])/r?p({which:13}):t.clientY>=i*(n[0]+n[1]+n[2])/r?p({which:40}):t.clientX<=u/2?p({which:37}):p({which:39})})})}()})();document.addEventListener("keydown",p);(st=function(){if(i){var t=(window.innerWidth-2*i.constants.padding)/i.board.width,r=(window.innerHeight-2*i.constants.padding)/i.board.height,n=1;s.clientHeight&&((t<1||r<1)&&(n=Math.min(t,r)),k.style["-ms-transform"]=k.style["-moz-transform"]=k.style["-o-transform"]=k.style["-webkit-transform"]=k.style.transform=n<1?"scale("+n+")":"")}})();window.addEventListener("resize",st);window.addEventListener("blur",function(){et?it(!0):i&&i.pause()});document.addEventListener("visibilitychange",function(){document.hidden&&(et?it(!0):i&&i.pause())},!1);window.setInterval(ht,100);document.addEventListener("DOMContentLoaded",function(){var n=b(v),h=parseInt(n&&n.baseLines)||parseInt(c().base)||0,y=document.getElementById("initial-lines"),r,t,i;[0,4,7,10,13].forEach(function(n){var i=document.createElement("label"),t=document.createElement("input");t.setAttribute("type","radio");t.setAttribute("name","initial-lines");t.value=n;n===h&&(t.checked=!0);i.appendChild(t);i.appendChild(document.createTextNode(n.toLocaleString()));y.appendChild(i)});r=c()["boss-color"]||f.getAttribute("boss-color");typeof r!="undefined"&&a(".boss { background-color: "+r+" !important; }");t=u.createPreviews();Array.from(document.getElementsByClassName("piece-stats")).forEach(function(n){l(n);var i=document.createElement("table");i.classList.add("stat-table");t.forEach(function(n){tt(n.preview);n.preview.classList.add("preview");var t=document.createElement("tr"),r=document.createElement("td");t.classList.add("stat-row");t.dataset.type=n.name;r.appendChild(n.preview);t.appendChild(r);r=document.createElement("td");r.classList.add("stat-value");t.appendChild(r);i.appendChild(t)});n.appendChild(i)});t=u.createPreviews();var e=t.map(function(n){return n.name}),p=document.getElementById("pieces"),o=document.createElement("table"),s=document.createElement("tr");n&&n.activePieces?e=n.activePieces:(i=c().pieces,i&&i.length&&(e=i.toUpperCase().split(/[^a-zA-Z0-9]+/)));t.forEach(function(n){var r=document.createElement("td"),i=document.createElement("label"),t=document.createElement("input");tt(n.preview);n.preview.classList.add("preview");t.setAttribute("type","checkbox");t.dataset.piece=n.name;e.includes(n.name)&&(t.checked=!0);i.appendChild(t);i.appendChild(n.preview);r.appendChild(i);s.appendChild(r)});o.appendChild(s);p.appendChild(o);g(n,!0)})}()})()