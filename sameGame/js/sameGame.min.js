"use strict";(function(){var l="same-game-state",o="session",y="same-game-style",t=Array.prototype.slice.call(window.document.getElementsByTagName("script")).pop();(function(){Array.prototype.findIndex||(Array.prototype.findIndex=function(n){for(var i=this,t=0,r=this.length;t<r;t++)if(n.call(i,this[t],t))return t;return-1});Array.from||(Array.from=function(n){for(var i=[],t=0,r=n.length;t<r;t++)i.push(n[t]);return i});var n=t.getAttribute("storage");n&&n.length&&(o=n);o+="Storage"})();var a=function(n,t){Array.from(typeof n.length!="undefined"?n:[n]).forEach(function(n){n.addEventListener("click",t)})},f=function(n,t,i){a(n.querySelectorAll("."+t),i)},p=function(n,t,i){a(n.getElementsByTagName(t),i)},w=function(n){var t={};return Object.keys(n).forEach(function(i){t[i]=n[i]}),t},n=function(){return Array.from(arguments.length===1?arguments[0]:arguments).join("_")},s=function(n){n.classList.add("hidden")},b=function(n){var r=function(n,t,i){return(i<0&&(i+=6),i>=6&&(i-=6),i<1)?(t-n)*i+n:i<3?t:i<4?(t-n)*(4-i)+n:n},i,t,f,e,o,u=n.h/60;return t=n.l<=.5?n.l*(n.s+1):n.l+n.s-n.l*n.s,i=n.l*2-t,f=r(i,t,u+2)*255,e=r(i,t,u)*255,o=r(i,t,u-2)*255,{r:Math.floor(f),g:Math.floor(e),b:Math.floor(o),a:n.a}},r=function(n){return!n.classList.contains("hidden")},rt=function(n){for(var t=undefined,i,r=0,u=n.length;r<u;r++)i=n[r],t=t===undefined?i:Math.max(t,i);return t},ut=function(n){for(var t=undefined,i,r=0,u=n.length;r<u;r++)i=n[r],t=t===undefined?i:Math.min(t,i);return t},e=function(n){return Object.keys(u()).findIndex(function(t){return t.toLowerCase()===n.toLowerCase()})>=0},u=function(n){var t=(n=n||window.location.href).indexOf("?"),i={};return t>=0&&(n=n.substr(t+1),t=n.indexOf("#"),t>=0&&(n=n.substr(0,t)),n.split("&").forEach(function(n){var t=n.indexOf("="),r=n.substr(0,t),u=n.substr(t+1);i[r||u]=r?window.decodeURIComponent(u):undefined})),i},k=function(n){var t=d(n);if(t&&t.length)try{return window.JSON.parse(t)}catch(i){}},d=function(n){try{var t=window[o];if(t&&t.getItem)return t.getItem(n)}catch(i){}},g=function(n){var h=n.r,c=n.g,l=n.b,i,r,f,o,s,e,u,t=[];for(t[0]=h/255,t[1]=c/255,t[2]=l/255,i=t[0],r=t[0],e=0,f=0;f<t.length-1;f++)t[f+1]<=i&&(i=t[f+1]),t[f+1]>=r&&(r=t[f+1],e=f+1);return e===0&&(u=(t[1]-t[2])/(r-i)),e===1&&(u=2+(t[2]-t[0])/(r-i)),e===2&&(u=4+(t[0]-t[1])/(r-i)),isNaN(u)&&(u=0),u=u*60,u<0&&(u+=360),o=(i+r)/2,s=i==r?0:o<.5?(r-i)/(r+i):(r-i)/(2-r-i),{h:u,s:s,l:o,a:n.a}},i=function(n,t,i){i?n.classList.contains(t)||n.classList.add(t):n.classList.contains(t)&&n.classList.remove(t)},c=function(n,t){var i;t&&(i=document.getElementById(t))?i.innerText=n:(i=document.createElement("style"),i.setAttribute("type","text/css"),t&&i.setAttribute("id",t),i.innerText=n,document.querySelector("head").appendChild(i))},nt=function(n,t){n.completed?t():n.executing?n.callbacks.push(t):(n.callbacks=[t],n.executing=!0,n(function(){n.completed=!0;n.executing=!1;for(var t=0,i=n.callbacks.length;t<i;t++)n.callbacks[t]()}))},h=function(n){n.classList.remove("hidden")},tt=function(n,t){typeof t!="undefined"&&(t=window.JSON.stringify(t));it(n,t)},it=function(n,t){try{var i=window[o];i&&(typeof t!="undefined"?i.setItem&&i.setItem(n,t):i.removeItem&&i.removeItem(n))}catch(r){}},ft=e("debug"),v;(function(){var r={get boardWidth(){return 16},get boardHeight(){return 10},get colors(){return 5},getBombsPerLevel:function(n){return n===1?3:2},get levels(){return 7},get padding(){return 8},get singleTileAdjustFactor(){return 3/4},get tileAdjustFactor(){return 2/3},get tileWidth(){return 40},get tileHeight(){return 40}},p=function(n){var t,u=Array(r.colors),i=Array(r.colors);for(Object.keys(n).map(function(t){return n[t]}).forEach(function(t){if(k(n,t)&&Math.random()<=r.singleTileAdjustFactor){var e=f(n,t);e>=0&&e!=t.color&&(t.adjusted=!0,t.color=e)}u[t.color]=t;i[t.color]++}),t=0;t<i.Length;t++)if(i[t]==0){if(r.boardWidth*r.boardHeight>=i.Length*i.length)return!1}else i[t]==1&&(u[t].color=f(n,u[t]));return!0},e=function(n){for(var t;!p(t=d(n)););return t},o=function(t,i){var r={},u;return(u=function(i){var f=n(i.x,i.y);typeof r[f]=="undefined"&&(r[f]=i,a(t,i).filter(function(n){return n.color===i.color}).forEach(u))})(i),Object.keys(r).map(function(n){return r[n]})},f=function(n,t){var i=a(n,t);return i.length&&i[Math.floor(Math.random()*i.length)].color},a=function(t,i){return[[i.x,i.y-1],[i.x-1,i.y],[i.x+1,i.y],[i.x,i.y+1]].map(function(i){return t[n(i[0],i[1])]}).filter(function(n){return!!n})},k=function(n,t){return o(n,t).length===1},d=function(t){for(var u,o=0,i={},e=0;e<r.boardWidth;e++)for(u=0;u<r.boardHeight;u++)i[n(e,u)]={n:o++,x:e,y:u,color:Math.floor(Math.random()*r.colors)};return Object.keys(i).map(function(n){return i[n]}).forEach(function(n){if(Math.random()<=r.tileAdjustFactor*(r.levels+1-t)/r.levels){var u=f(i,n);u>=0&&u!=n.color&&(n.adjusted=!0,n.color=u)}}),i};v=function(f,a,v,p){var wt=function(n){nt(bt,n)},bt=function(n){var i=!window.location.protocol.match(/http/i),f=new Image,e,o;f.onerror=function(){n()};f.onload=function(){var o,s=this.width,h=this.height,t,l,a,e,u,f;for(Object.defineProperty(r,"colors",{get:function(){return s*h}}),t=[],l=0,i||function(n){var t=document.createElement("canvas");t.width=s;t.height=h;o=t.getContext("2d",{willReadFrequently:!0});o.drawImage(n,0,0)}(this),a=function(n){return{r:n.data[0],g:n.data[1],b:n.data[2],a:n.data[3]}},e=function(n){return typeof n.a!="undefined"&&n.a<255?"rgba("+[n.r,n.g,n.b,Math.round((n.a/255+(Number.EPSILON||0))*1e3)/1e3].join(", ")+")":"#"+[n.r,n.g,n.b].map(function(n){return("0"+n.toString(16)).slice(-2)}).join("")},i&&t.push('.tile { background-image: url("'+this.src+'") !important; background-repeat: no-repeat; background-size: cover; border: none; }'),u=0;u<s;u++)for(f=0;f<h;f++)i?t.push(".tile.color-"+(++l).toString()+" { background-position: "+-(u*r.tileWidth)+"px "+-(f*r.tileHeight)+"px }"):function(){var i=a(o.getImageData(u,f,1,1)),n=g(i);n.l+=Math.min(((n.l+.945)/2-n.l)*.6,1);t.push(".tile.color-"+(++l).toString()+" { background-color: "+e(i)+"; background-image: linear-gradient(to bottom right, "+e(i)+", "+e(b(n))+" 100%); }")}();c(t.join("\n"));n()};e=parseInt(u().palette||t.getAttribute("palette"));isNaN(e)?(o=u().palette||t.getAttribute("palette")||u(t.getAttribute("src")).palette,o?(i||f.setAttribute("crossOrigin","Anonymous"),f.src="images/palettes/"+o+".png"):n()):(Array.from(document.getElementsByClassName("board")).forEach(function(n){n.classList.add("default-palette");n.classList.add("palette-"+e.toString())}),n())},at=0,ut=!1,it,ot,d,st,et,rt,ct,k,vt;(function(){var t=[],n;for(t.push(".scaler .level { font-size: "+Math.floor(r.boardHeight*r.tileHeight*.8).toString()+"pt}"),t.push(".tile { font-size: "+Math.floor(r.tileHeight*.4).toString()+"pt; left: "+r.padding+"px; top: "+r.padding+"px; width: "+r.tileWidth+"px; height: "+r.tileHeight+"px}"),n=0;n<r.boardWidth;n++)t.push(".column-"+(n+1).toString()+" { left: "+(n*r.tileWidth+r.padding).toString()+"px }");for(n=0;n<r.boardHeight;n++)t.push(".row-"+(n+1).toString()+" { top: "+(n*r.tileHeight+r.padding).toString()+"px }");c(t.join("\n"),y)})();var ht=function(t){var u={},i={},o,s,h;vt=0;o=Object.keys(k).filter(function(t){var r=k[t],f;return vt++,typeof u[t]=="undefined"?(u[t]=!0,typeof i[r.color]=="undefined"&&(i[r.color]=0),i[r.color]++,f=lt(r),f.slice(1).forEach(function(t){u[n(t.x,t.y)]=!0;i[t.color]++}),f.length>1):void 0});at=o.length;s=Object.keys(i).map(function(n){return i[n]}).filter(function(n){return n===1}).length;h=s<=it;it<=0&&(h&&=at>0);f.dispatchEvent(new Event("game.changed"));f.getElementsByClassName("tile").length===f.getElementsByClassName("hidden").length?ot||(et<r.levels?setTimeout(function(){k=e(++et);pt();d.splice(0,d.length);ft(!0);ht()},200):(ot=Date.now(),f.dispatchEvent(new Event("game.won")))):(f.querySelector(".tile.last")||!h)&&(ot||(ot=Date.now(),f.dispatchEvent(new Event("game.lost"))));tt(l,ot?undefined:{bombs:it,history:d,level:et,start:ct,tileSet:k});t!==!1&&(it>0&&s>0&&Object.keys(i).map(function(n){return i[n]}).filter(function(n){return n>1}).length<=1?window.setTimeout(function(){var n,r,u,t;for(n in i)if(i[n]===1){r=parseInt(n);for(u in k)if(t=k[u],t.color===r){ut=!0;yt([t]);ft();ht(!0);break}break}}):t&&Object.keys(i).length===1&&window.setTimeout(function(){yt(lt(o.map(function(n){return k[n]}).pop()));ft();ht()}))},lt=function(n){return o(k,n)},yt=function(t){var e={},o={},h=function(n,t,i){var r=o[n];return typeof r=="undefined"&&(o[n]=r={key:n,x:t,y:i,xSteps:0,ySteps:0}),r},i,u,f,s;t.forEach(function(t){e[n(t.x,t.y)]=t});t.forEach(function(t){for(var r,i,u=t.y-1;u>=0;u--)i=k[r=n(t.x,u)],i&&typeof e[r]=="undefined"&&h(r,i.x,i.y).ySteps++});i=Array.from(Array(r.boardWidth)).map(function(){return!1});u=Object.keys(k).filter(function(n){return typeof e[n]=="undefined"});u.forEach(function(n){i[k[n].x]=!0}),function(){var n=0;i=i.map(function(t){return t||n++,n})}();u.forEach(function(n){var t=k[n],r=i[t.x];r>0&&(h(n,t.x,t.y).xSteps-=r)});f={};s={bomb:ut};Object.keys(k).forEach(function(n){s[n]=w(k[n])});d.push(s);u.forEach(function(t){var i=k[t],r=o[t];typeof r!="undefined"?(i.x+=r.xSteps,i.y+=r.ySteps,f[n(i.x,i.y)]=i):f[t]=i});k=f;ut&&(it--,ut=!1)},pt=function(){it=a&&a.noBomb?0:r.getBombsPerLevel(et)},ft=function(t){var e={},o=[],c=[],l=[],a=[],v=Array.from(Array(r.colors)).map(function(){return 0}),u;for(Object.keys(k).forEach(function(t){var i=k[t],r;a[i.n]=i;v[i.color]++;typeof e[t]=="undefined"&&(r=lt(i),r.forEach(function(t){e[n(t.x,t.y)]=r.length}))}),u=0;u<r.colors;u++)o.push("color-"+(u+1).toString());for(u=0;u<r.boardWidth;u++)c.push("column-"+(u+1).toString());for(u=0;u<r.boardHeight;u++)l.push("row-"+(u+1).toString());Array.from(f.getElementsByClassName("tile")).forEach(function(r){var u=a[parseInt(r.dataset.n)],y,p,w,f;i(r,"move",u);(u?h:s)(r);u&&(y="column-"+(u.x+1).toString(),p="row-"+(u.y+1).toString(),c.forEach(function(n){i(r,n,n===y)}),l.forEach(function(n){i(r,n,n===p)}),t&&(r.classList.remove("move"),w="color-"+(u.color+1).toString(),o.forEach(function(n){i(r,n,n===w)})),i(r,"adjusted",u.adjusted),i(r,"pressed",st&&rt&&rt.filter(function(n){return n.x===u.x&&n.y===u.y}).length>0),f=e[n(u.x,u.y)],r.innerText=f>1&&!ut?f.toLocaleString():"",i(r,"last",f===1&&v[u.color]===1))});t&&window.setTimeout(function(){Array.from(f.getElementsByClassName("tile")).forEach(function(n){n.classList.add("move")})},500)};return wt(function(){try{Array.from(f.childNodes).forEach(function(n){n.parentElement.removeChild(n)});f.style.padding=r.padding+"px";f.style.width=r.tileWidth*r.boardWidth+2*r.padding+"px";f.style.height=r.tileHeight*r.boardHeight+2*r.padding+"px";p?(it=p.bombs,d=p.history,et=p.level,ct=p.start,k=p.tileSet):(et=1,pt(),d=[]),function(){var t=function(t){var r=parseInt(t.srcElement.dataset.n),i=Object.keys(k).map(function(n){return k[n]}).filter(function(n){return n.n===r}).pop();return lt(k[n(i.x,i.y)])};Object.keys(k=k||e(et)).map(function(n){return k[n]}).forEach(function(n){var i=document.createElement("div");i.classList.add("tile");i.classList.add("fade");i.classList.add("move");i.dataset.n=n.n;i.addEventListener("mousedown",function(n){if(n.which===1){var i=t(n),r=ut||n.shiftKey;(r||i.length>1)&&(rt=r?[i[0]]:i,st=!0,ft())}});i.addEventListener("mousemove",function(n){if(n.which===1){var i=t(n)[0],r=rt&&rt.filter(function(n){return n.x===i.x&&n.y===i.y}).length>0;r!==st&&(st=r,ft())}});i.addEventListener("mouseout",function(n){n.which===1&&st&&!document.elementFromPoint(n.clientX,n.clientY).classList.contains("tile")&&(st=!1,ft())});i.addEventListener("mouseup",function(n){if(n.which===1){var r=t(n),i=r[0];rt&&rt.filter(function(n){return n.x===i.x&&n.y===i.y}).length>0&&(rt.length===1&&(ut=!0),yt(rt),ct||(ct=Date.now()));rt=undefined;st=!1;ft();ht()}});f.appendChild(i)});ft(!0);ht()}();v&&v()}catch(t){f.dispatchEvent(new Event("game.wrong"))}}),{get availableMoves(){return at},get bomb(){return ut},set bomb(n){ut=n},get bombs(){return it},board:{get width(){return r.boardWidth*r.tileWidth},get height(){return r.boardHeight*r.tileHeight}},get constants(){return r},get end(){return ot},get level(){return et},get history(){return d},get start(){return ct},undo:function(n){d.length&&(n?(k=d[0],d.splice(0,d.length),pt()):(k=d.pop(),k.bomb&&it++,delete k.bomb),ot=undefined,ft(!0),ht(!1))},get visibleTiles(){return vt}}}})(),function(){var at="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=",vt=decodeURIComponent("%E3%85%A4"),a=document.querySelector(".board"),o=document.getElementById("message"),b=document.querySelector(".scaler"),rt=document.querySelector(".status");(function(){typeof ShadowRoot=="undefined"&&o.classList.add("compatible");e("animate")&&document.querySelector("body").classList.add("animate")})();var w,ut,n,ot,st,ht,ft,ct,lt=function(){r(o)?(d(),tt()):n&&n.history.length?g(document.getElementById("askNewMessage").value):tt()},nt=function(n){if(Array.from(document.getElementsByClassName("boss")).forEach(function(t){(n?h:s)(t)}),w!==n){var t=document.querySelector("[rel='shortcut icon']");(w=n)?(ct=document.title,document.title=vt,t&&(ot=t.getAttribute("href"),t.setAttribute("href",at))):(document.title=ct,t&&t.setAttribute("href",ot))}},y=function(){et&&et();Array.from(document.getElementsByClassName("level")).forEach(function(t){t.innerText=n?n.level:undefined});Array.from(document.getElementsByClassName("bombs")).forEach(function(t){t.innerText=n?n.bombs:undefined;i(t,"active",n&&n.bomb);n&&n.bombs>0?t.removeAttribute("disabled"):t.setAttribute("disabled","disabled")});Array.from(document.getElementsByClassName("moves")).forEach(function(t){t.innerText=n?n.availableMoves:undefined});Array.from(document.getElementsByClassName("remaining")).forEach(function(t){t.innerText=n?n.visibleTiles:undefined});Array.from(document.querySelectorAll(".undo, .restart")).forEach(function(t){n&&n.history.length?t.removeAttribute("disabled"):t.setAttribute("disabled","disabled")})},d=function(){s(o);s(document.getElementById("messageBackdrop"))},tt=function(t){n&&(n=undefined,a.removeEventListener("game.changed",y));n=new v(a,{noBomb:ht},function(){a.addEventListener("game.changed",y);setTimeout(function(){ft();y()})},t)},et=function(){var t=0,i,r="";n&&n.start&&(t=(n.end||Date.now())-n.start);t=Math.floor(t/1e3);t>=3600&&(r=Math.floor(t/3600)+":",t%=3600);i=Math.floor(t/60);t%=60;r.length&&i<10&&(i="0"+i);r+=i+":";t<10&&(t="0"+t);document.getElementById("time").innerText=r+t},yt=function(){it(!0);d()},g=function(n){w||(document.getElementById("messageText").innerText=n,h(document.getElementById("messageBackdrop")),h(o))},it=function(t){n.undo(t);y()};(function(){var r,s;a.addEventListener("game.changed",y);a.addEventListener("game.won",function(){g(document.getElementById("wonMessage").value)});a.addEventListener("game.lost",function(){g(document.getElementById("lostMessage").value)});a.addEventListener("game.wrong",function(){g(document.getElementById("wrongGameMessage").value)});f(rt,"newGame",lt);f(rt,"undo",function(){it()});f(rt,"bombs",function(){n&&n.bombs>0&&(n.bomb=!n.bomb,y())});document.getElementById("messageBackdrop").addEventListener("click",function(){d()});p(o,"button",d);f(o,"newGame",function(){tt()});f(o,"restart",yt);ut=e("boss")||!!parseInt(t.getAttribute("boss"));r=u()["boss-color"]||t.getAttribute("boss-color");typeof r!="undefined"&&c(".boss { background-color: "+r+" !important; }");s=u().version||t.getAttribute("version");s&&Array.from(document.getElementsByClassName("version")).forEach(function(n){n.innerText=s});i(document.body,"no-bomb",ht=!(e("bombs")||!!parseInt(t.getAttribute("bombs"))));st=e("large")||!!parseInt(t.getAttribute("large"))})();document.addEventListener("keydown",function(t){switch(t.which){case 13:r(o)&&o.getElementsByTagName("button")[0].click();break;case 27:!w&&r(o)?d():ut&&!w&&nt(!0);break;case 66:t.ctrlKey?n&&n.bombs>0&&(n.bomb=!n.bomb,y()):nt(!w);break;case 68:g((new Date).toLocaleString());break;case 90:t.ctrlKey&&(r(o)||it());break;case 113:r(o)||lt();break;case 221:t.ctrlKey&&(r(o)||it(!0))}});(ft=function(){if(n){var i=(window.innerWidth-256-2*n.constants.padding)/n.board.width,r=(window.innerHeight-2*n.constants.padding)/n.board.height,t=1;a.clientHeight&&(i<1||r<1?t=Math.min(i,r):st||(window.getComputedStyle(document.body).getPropertyValue("--screen")||"").match(/large/i)&&(t*=.55),b.style["-ms-transform"]=b.style["-moz-transform"]=b.style["-o-transform"]=b.style["-webkit-transform"]=b.style.transform=t<1?"scale("+t+")":"")}})();window.addEventListener("resize",ft);ut&&(window.addEventListener("blur",function(){nt(!0)}),document.addEventListener("visibilitychange",function(){document.hidden&&nt(!0)},!1));window.setInterval(et,100);document.addEventListener("DOMContentLoaded",function(){tt(k(l))})}()})()