"use strict";(function(){var c="same-game-state",f="session",y="same-game-style",i=Array.prototype.slice.call(window.document.getElementsByTagName("script")).pop();(function(){Array.prototype.findIndex||(Array.prototype.findIndex=function(n){for(var i=this,t=0,r=this.length;t<r;t++)if(n.call(i,this[t],t))return t;return-1});Array.from||(Array.from=function(n){for(var i=[],t=0,r=n.length;t<r;t++)i.push(n[t]);return i});var n=i.getAttribute("storage");n&&n.length&&(f=n);f+="Storage"})();var l=function(n,t){Array.from(typeof n.length!="undefined"?n:[n]).forEach(function(n){n.addEventListener("click",t)})},r=function(n,t,i){l(n.querySelectorAll("."+t),i)},p=function(n,t,i){l(n.getElementsByTagName(t),i)},w=function(n){var t={};return Object.keys(n).forEach(function(i){t[i]=n[i]}),t},n=function(){return Array.from(arguments.length===1?arguments[0]:arguments).join("_")},e=function(n){n.classList.add("hidden")},u=function(n){return!n.classList.contains("hidden")},nt=function(n){for(var t=undefined,i,r=0,u=n.length;r<u;r++)i=n[r],t=t===undefined?i:Math.max(t,i);return t},tt=function(n){for(var t=undefined,i,r=0,u=n.length;r<u;r++)i=n[r],t=t===undefined?i:Math.min(t,i);return t},o=function(n){return Object.keys(s()).findIndex(function(t){return t.toLowerCase()===n.toLowerCase()})>=0},s=function(n){var t=(n=n||window.location.href).indexOf("?"),i={};return t>=0&&(n=n.substr(t+1),t=n.indexOf("#"),t>=0&&(n=n.substr(0,t)),n.split("&").forEach(function(n){var t=n.indexOf("="),r=n.substr(0,t),u=n.substr(t+1);i[r||u]=r?window.decodeURIComponent(u):undefined})),i},b=function(n){var t=k(n);if(t&&t.length)try{return window.JSON.parse(t)}catch(i){}},k=function(n){try{var t=window[f];if(t&&t.getItem)return t.getItem(n)}catch(i){}},t=function(n,t,i){i?n.classList.contains(t)||n.classList.add(t):n.classList.contains(t)&&n.classList.remove(t)},a=function(n,t){var i;t&&(i=document.getElementById(t))?i.innerText=n:(i=document.createElement("style"),i.setAttribute("type","text/css"),t&&i.setAttribute("id",t),i.innerText=n,document.querySelector("head").appendChild(i))},h=function(n){n.classList.remove("hidden")},d=function(n,t){typeof t!="undefined"&&(t=window.JSON.stringify(t));g(n,t)},g=function(n,t){try{var i=window[f];i&&(typeof t!="undefined"?i.setItem&&i.setItem(n,t):i.removeItem&&i.removeItem(n))}catch(r){}},it=o("debug"),v;(function(){var i={get boardWidth(){return 16},get boardHeight(){return 10},get colors(){return 5},getBombsPerLevel:function(n){return n===1?3:2},get levels(){return 7},get padding(){return 8},get singleTileAdjustFactor(){return 3/4},get tileAdjustFactor(){return 2/3},get tileWidth(){return 40},get tileHeight(){return 40}},o=function(n){for(var e=Array(i.colors),f=Array(i.colors),u,t=0;t<n.length;t++)u=n[t],isTileSingle(u)&&Math.random()<=i.singleTileAdjustFactor&&(u.color=r(n,u),u.adjusted=!0),e[u.color]=u,f[u.color]++;for(t=0;t<f.Length;t++)if(f[t]==0){if(i.boardWidth*i.boardHeight>=f.Length*f.length)return!1}else f[t]==1&&(e[t].color=r(n,e[t]));return!0},u=function(n){for(var t;!o(t=l(n)););return t},s=function(t,i){var r={},u;return(u=function(i){var e=n(i.x,i.y);typeof r[e]=="undefined"&&(r[e]=i,f(t,i).filter(function(n){return n.color===i.color}).forEach(u))})(i),Object.keys(r).map(function(n){return r[n]})},r=function(n,t){var i=f(n,t);return i.length&&i[Math.floor(Math.random()*i.length)].color},f=function(t,i){return[[i.x,i.y-1],[i.x-1,i.y],[i.x+1,i.y],[i.x,i.y+1]].map(function(i){return t[n(i[0],i[1])]}).filter(function(n){return!!n})},p=function(n,t){return getBlock(n,t).length===1},l=function(t){for(var f,u,e,h=0,o={},s=0;s<i.boardWidth;s++)for(f=0;f<i.boardHeight;f++)u={n:h++,x:s,y:f,color:Math.floor(Math.random()*i.colors)},Math.random()<=i.tileAdjustFactor*(i.levels+1-t)/i.levels&&(e=r(o,u),e>=0&&e!=u.color&&(u.adjusted=!0,u.color=e)),o[n(u.x,u.y)]=u;return o};v=function(r,f,o,l){var ot=0,g=!1,b,it,p,rt,tt,k,ft,v,st;(function(){var t=[],n;for(t.push(".scaler .level { font-size: "+Math.floor(i.boardHeight*i.tileHeight*.8).toString()+"pt}"),t.push(".tile { font-size: "+Math.floor(i.tileHeight*.4).toString()+"pt; left: "+i.padding+"px; top: "+i.padding+"px; width: "+i.tileWidth+"px; height: "+i.tileHeight+"px}"),n=0;n<i.boardWidth;n++)t.push(".column-"+(n+1).toString()+" { left: "+(n*i.tileWidth+i.padding).toString()+"px }");for(n=0;n<i.boardHeight;n++)t.push(".row-"+(n+1).toString()+" { top: "+(n*i.tileHeight+i.padding).toString()+"px }");a(t.join("\n"),y)})();var ut=function(t){var e={},f={},o,s,h;st=0;o=Object.keys(v).filter(function(t){var i=v[t],r;return st++,typeof e[t]=="undefined"?(e[t]=!0,typeof f[i.color]=="undefined"&&(f[i.color]=0),f[i.color]++,r=et(i),r.slice(1).forEach(function(t){e[n(t.x,t.y)]=!0;f[t.color]++}),r.length>1):void 0});ot=o.length;s=Object.keys(f).map(function(n){return f[n]}).filter(function(n){return n===1}).length;h=s<=b;b<=0&&(h&=ot>0);r.dispatchEvent(new Event("game.changed"));r.getElementsByClassName("tile").length===r.getElementsByClassName("hidden").length?it||(tt<i.levels?setTimeout(function(){v=u(++tt);ct();p.splice(0,p.length);nt(!0);ut()}):(it=Date.now(),r.dispatchEvent(new Event("game.won")))):(r.querySelector(".tile.fatal")||!h)&&(it||(it=Date.now(),r.dispatchEvent(new Event("game.lost"))));d(c,it?undefined:{bombs:b,history:p,level:tt,start:ft,tileSet:v});t!==!1&&(b>0&&s>0&&Object.keys(f).map(function(n){return f[n]}).filter(function(n){return n>1}).length<=1?window.setTimeout(function(){var n,i,r,t;for(n in f)if(f[n]===1){i=parseInt(n);for(r in v)if(t=v[r],t.color===i){g=!0;ht([t]);nt();ut(!0);break}break}}):t&&Object.keys(f).length===1&&window.setTimeout(function(){ht(et(o.map(function(n){return v[n]}).pop()));nt();ut()}))},et=function(n){return s(v,n)},ht=function(t){var e={},o={},h=function(n,t,i){var r=o[n];return typeof r=="undefined"&&(o[n]=r={key:n,x:t,y:i,xSteps:0,ySteps:0}),r},r,u,f,s;t.forEach(function(t){e[n(t.x,t.y)]=t});t.forEach(function(t){for(var r,i,u=t.y-1;u>=0;u--)i=v[r=n(t.x,u)],i&&typeof e[r]=="undefined"&&h(r,i.x,i.y).ySteps++});r=Array.from(Array(i.boardWidth)).map(function(){return!1});u=Object.keys(v).filter(function(n){return typeof e[n]=="undefined"});u.forEach(function(n){r[v[n].x]=!0}),function(){var n=0;r=r.map(function(t){return t||n++,n})}();u.forEach(function(n){var t=v[n],i=r[t.x];i>0&&(h(n,t.x,t.y).xSteps-=i)});f={};s={bomb:g};Object.keys(v).forEach(function(n){s[n]=w(v[n])});p.push(s);u.forEach(function(t){var i=v[t],r=o[t];typeof r!="undefined"?(i.x+=r.xSteps,i.y+=r.ySteps,f[n(i.x,i.y)]=i):f[t]=i});v=f;g&&(b--,g=!1)},ct=function(){b=f&&f.noBomb?0:i.getBombsPerLevel(tt)},nt=function(u){var o={},s=[],c=[],l=[],a=[],y=Array.from(Array(i.colors)).map(function(){return 0}),f;for(Object.keys(v).forEach(function(t){var i=v[t],r;a[i.n]=i;y[i.color]++;typeof o[t]=="undefined"&&(r=et(i),r.forEach(function(t){o[n(t.x,t.y)]=r.length}))}),f=0;f<i.colors;f++)s.push("color-"+(f+1).toString());for(f=0;f<i.boardWidth;f++)c.push("column-"+(f+1).toString());for(f=0;f<i.boardHeight;f++)l.push("row-"+(f+1).toString());Array.from(r.getElementsByClassName("tile")).forEach(function(i){var r=a[parseInt(i.dataset.n)],v,p,w,f;t(i,"move",r);(r?h:e)(i);r&&(v="column-"+(r.x+1).toString(),p="row-"+(r.y+1).toString(),c.forEach(function(n){t(i,n,n===v)}),l.forEach(function(n){t(i,n,n===p)}),u&&(i.classList.remove("move"),w="color-"+(r.color+1).toString(),s.forEach(function(n){t(i,n,n===w)})),t(i,"adjusted",r.adjusted),t(i,"pressed",rt&&k&&k.filter(function(n){return n.x===r.x&&n.y===r.y}).length>0),f=o[n(r.x,r.y)],i.innerText=f>1&&!g?f.toLocaleString():"",t(i,"last",f===1&&y[r.color]===1))});u&&window.setTimeout(function(){Array.from(r.getElementsByClassName("tile")).forEach(function(n){n.classList.add("move")})},500)};return function(){try{Array.from(r.childNodes).forEach(function(n){n.parentElement.removeChild(n)});r.style.padding=i.padding+"px";r.style.width=i.tileWidth*i.boardWidth+2*i.padding+"px";r.style.height=i.tileHeight*i.boardHeight+2*i.padding+"px";l?(b=l.bombs,p=l.history,tt=l.level,ft=l.start,v=l.tileSet):(tt=1,ct(),p=[]),function(){var t=function(t){var r=parseInt(t.srcElement.dataset.n),i=Object.keys(v).map(function(n){return v[n]}).filter(function(n){return n.n===r}).pop();return et(v[n(i.x,i.y)])};Object.keys(v=v||u(tt)).map(function(n){return v[n]}).forEach(function(n){var i=document.createElement("div");i.classList.add("tile");i.classList.add("fade");i.classList.add("move");i.dataset.n=n.n;i.addEventListener("mousedown",function(n){if(n.which===1){var i=t(n),r=g||n.shiftKey;(r||i.length>1)&&(k=r?[i[0]]:i,rt=!0,nt())}});i.addEventListener("mousemove",function(n){if(n.which===1){var i=t(n)[0],r=k&&k.filter(function(n){return n.x===i.x&&n.y===i.y}).length>0;r!==rt&&(rt=r,nt())}});i.addEventListener("mouseout",function(n){n.which===1&&rt&&!document.elementFromPoint(n.clientX,n.clientY).classList.contains("tile")&&(rt=!1,nt())});i.addEventListener("mouseup",function(n){if(n.which===1){var r=t(n),i=r[0];k&&k.filter(function(n){return n.x===i.x&&n.y===i.y}).length>0&&(k.length===1&&(g=!0),ht(k),ft||(ft=Date.now()));k=undefined;rt=!1;nt();ut()}});r.appendChild(i)});nt(!0);ut()}();o&&o()}catch(t){r.dispatchEvent(new Event("game.wrong"))}}(),{get availableMoves(){return ot},get bomb(){return g},set bomb(n){g=n},get bombs(){return b},board:{get width(){return i.boardWidth*i.tileWidth},get height(){return i.boardHeight*i.tileHeight}},get constants(){return i},get end(){return it},get level(){return tt},get history(){return p},get start(){return ft},undo:function(n){p.length&&(n?(v=p[0],p.splice(0,p.length),ct()):(v=p.pop(),v.bomb&&b++,delete v.bomb),it=undefined,nt(!0),ut(!1))},get visibleTiles(){return st}}}})(),function(){var lt="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=",at=decodeURIComponent("%E3%85%A4"),l=document.querySelector(".board"),f=document.getElementById("message"),d=document.querySelector(".scaler"),g=document.querySelector(".status");(function(){typeof ShadowRoot=="undefined"&&f.classList.add("compatible");o("animate")&&document.querySelector("body").classList.add("animate")})();var w,ut,n,ot,st,ft,ht,ct=function(){u(f)?(tt(),it()):n&&n.history.length?k(document.getElementById("askNewMessage").value):it()},vt=function(){k(document.getElementById("restartMessage").value)},nt=function(n){if(Array.from(document.getElementsByClassName("boss")).forEach(function(t){(n?h:e)(t)}),w!==n){var t=document.querySelector("[rel='shortcut icon']");(w=n)?(ht=document.title,document.title=at,t&&(ot=t.getAttribute("href"),t.setAttribute("href",lt))):(document.title=ht,t&&t.setAttribute("href",ot))}},y=function(){et&&et();Array.from(document.getElementsByClassName("level")).forEach(function(t){t.innerText=n?n.level:undefined});Array.from(document.getElementsByClassName("bombs")).forEach(function(i){i.innerText=n?n.bombs:undefined;t(i,"active",n&&n.bomb);n&&n.bombs>0?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled")});Array.from(document.getElementsByClassName("moves")).forEach(function(t){t.innerText=n?n.availableMoves:undefined});Array.from(document.getElementsByClassName("remaining")).forEach(function(t){t.innerText=n?n.visibleTiles:undefined});Array.from(document.querySelectorAll(".undo, .restart")).forEach(function(t){n&&n.history.length?t.removeAttribute("disabled"):t.setAttribute("disabled","disabled")})},tt=function(){e(f);e(document.getElementById("messageBackdrop"))},it=function(t){n&&(n=undefined,l.removeEventListener("game.changed",y));n=new v(l,{noBomb:st},function(){l.addEventListener("game.changed",y);setTimeout(function(){ft();y()})},t)},et=function(){var t=0,i,r="";n&&n.start&&(t=(n.end||Date.now())-n.start);t=Math.floor(t/1e3);t>=3600&&(r=Math.floor(t/3600)+":",t%=3600);i=Math.floor(t/60);t%=60;r.length&&i<10&&(i="0"+i);r+=i+":";t<10&&(t="0"+t);document.getElementById("time").innerText=r+t},yt=function(){rt(!0)},k=function(n){w||(document.getElementById("messageText").innerText=n,h(document.getElementById("messageBackdrop")),h(f))},rt=function(t){n.undo(t);y()};(function(){var u,e,h;l.addEventListener("game.changed",y);l.addEventListener("game.won",function(){k(document.getElementById("wonMessage").value)});l.addEventListener("game.lost",function(){k(document.getElementById("lostMessage").value)});l.addEventListener("game.wrong",function(){k(document.getElementById("wrongGameMessage").value)});r(g,"newGame",ct);r(g,"undo",function(){rt()});r(g,"restart",vt);r(g,"bombs",function(){n&&n.bombs>0&&(n.bomb=!n.bomb,y())});document.getElementById("messageBackdrop").addEventListener("click",function(){tt()});p(f,"button",tt);r(f,"newGame",function(){it()});r(f,"restart",yt);ut=o("boss")||!!parseInt(i.getAttribute("boss"));u=s()["boss-color"]||i.getAttribute("boss-color");typeof u!="undefined"&&a(".boss { background-color: "+u+" !important; }");e=s().version||i.getAttribute("version");e&&Array.from(document.getElementsByClassName("version")).forEach(function(n){n.innerText=e});h=parseInt(s().palette||i.getAttribute("palette"))||0;Array.from(document.getElementsByClassName("board")).forEach(function(n){n.classList.add("palette-"+h.toString())});t(document.body,"no-bomb",st=o("no-bomb")||!!parseInt(i.getAttribute("no-bomb")))})();document.addEventListener("keydown",function(t){switch(t.which){case 13:u(f)&&f.getElementsByTagName("button")[0].click();break;case 27:!w&&u(f)?tt():ut&&!w&&nt(!0);break;case 66:t.ctrlKey?n&&n.bombs>0&&(n.bomb=!n.bomb,y()):nt(!w);break;case 68:k((new Date).toLocaleString());break;case 90:t.ctrlKey&&(u(f)||rt());break;case 113:u(f)||ct();break;case 221:t.ctrlKey&&(u(f)||rt(!0))}});(ft=function(){if(n){var i=(window.innerWidth-256-2*n.constants.padding)/n.board.width,r=(window.innerHeight-2*n.constants.padding)/n.board.height,t=1;l.clientHeight&&(i<1||r<1?t=Math.min(i,r):(window.getComputedStyle(document.body).getPropertyValue("--screen")||"").match(/large/i)&&(t/=2),d.style["-ms-transform"]=d.style["-moz-transform"]=d.style["-o-transform"]=d.style["-webkit-transform"]=d.style.transform=t<1?"scale("+t+")":"")}})();window.addEventListener("resize",ft);ut&&(window.addEventListener("blur",function(){nt(!0)}),document.addEventListener("visibilitychange",function(){document.hidden&&nt(!0)},!1));window.setInterval(et,100);document.addEventListener("DOMContentLoaded",function(){it(b(c))})}()})()